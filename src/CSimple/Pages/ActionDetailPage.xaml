<?xml version="1.0" encoding="utf-8"?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:CSimple.Pages"
             x:Class="CSimple.Pages.ActionDetailPage"
             Title="Action Details"
             BackgroundColor="{AppThemeBinding Light=#f8f9fa, Dark=#121212}">
    <Grid RowDefinitions="Auto,*,Auto"
          Padding="16">
        <!-- Simple header with back button -->
        <Grid Grid.Row="0"
              RowDefinitions="Auto,Auto"
              Margin="0,0,0,16">
            <Button Grid.Row="0"
                    Text="← Back to Actions"
                    Command="{Binding BackCommand}"
                    HorizontalOptions="Start"
                    BackgroundColor="Transparent"
                    TextColor="{AppThemeBinding Light=#0d47a1, Dark=#90caf9}"
                    FontSize="14"
                    Padding="0"
                    Margin="0,0,0,8" />
            <VerticalStackLayout Grid.Row="1"
                                 Spacing="8">
                <Label Text="{Binding ActionName}"
                       FontSize="28"
                       FontAttributes="Bold" />
                <Grid ColumnDefinitions="Auto,Auto,Auto,*">
                    <Border Padding="8,4"
                            BackgroundColor="{AppThemeBinding Light=#e3f2fd, Dark=#0d47a1}"
                            StrokeShape="RoundRectangle 4">
                        <Label Text="{Binding ActionType}"
                               FontSize="14"
                               TextColor="{AppThemeBinding Light=#0d47a1, Dark=#90caf9}" />
                    </Border>
                    <Label Text="|"
                           Grid.Column="1"
                           TextColor="Gray"
                           Margin="12,0"
                           VerticalOptions="Center" />
                    <Label Text="{Binding CreatedAt}"
                           Grid.Column="2"
                           TextColor="Gray"
                           VerticalOptions="Center" />
                    <Button Text="Execute"
                            Grid.Column="3"
                            Command="{Binding ExecuteCommand}"
                            HorizontalOptions="End"
                            BackgroundColor="{AppThemeBinding Light=#4CAF50, Dark=#388E3C}"
                            TextColor="White"
                            WidthRequest="100"
                            HeightRequest="36"
                            CornerRadius="18" />
                </Grid>
            </VerticalStackLayout>
        </Grid>
        <!-- Content -->
        <ScrollView Grid.Row="1">
            <VerticalStackLayout Spacing="16"
                                 Padding="0,0,0,16">
                <!-- Action Summary -->
                <Frame Padding="16"
                       CornerRadius="8"
                       BorderColor="{AppThemeBinding Light=#e0e0e0, Dark=#333333}"
                       BackgroundColor="{AppThemeBinding Light=White, Dark=#1e1e1e}">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Summary"
                               FontAttributes="Bold"
                               FontSize="18" />
                        <Label Text="{Binding Description}"
                               TextColor="{AppThemeBinding Light=#616161, Dark=#b0bec5}" />
                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light=#e0e0e0, Dark=#333333}"
                                 Margin="0,8" />
                        <!-- Performance metrics -->
                        <Grid ColumnDefinitions="*,*,*"
                              RowDefinitions="Auto,Auto">
                            <Label Text="Usage"
                                   Grid.Row="0"
                                   Grid.Column="0"
                                   TextColor="{AppThemeBinding Light=#616161, Dark=#b0bec5}"
                                   FontSize="12" />
                            <Label Text="Success Rate"
                                   Grid.Row="0"
                                   Grid.Column="1"
                                   TextColor="{AppThemeBinding Light=#616161, Dark=#b0bec5}"
                                   FontSize="12" />
                            <Label Text="Duration"
                                   Grid.Row="0"
                                   Grid.Column="2"
                                   TextColor="{AppThemeBinding Light=#616161, Dark=#b0bec5}"
                                   FontSize="12" />
                            <Label Text="{Binding UsageCount}"
                                   Grid.Row="1"
                                   Grid.Column="0"
                                   FontSize="16"
                                   FontAttributes="Bold" />
                            <Label Text="{Binding SuccessRate, StringFormat='{0:P0}'}"
                                   Grid.Row="1"
                                   Grid.Column="1"
                                   FontSize="16"
                                   FontAttributes="Bold" />
                            <Label Text="{Binding Duration}"
                                   Grid.Row="1"
                                   Grid.Column="2"
                                   FontSize="16"
                                   FontAttributes="Bold" />
                        </Grid>
                    </VerticalStackLayout>
                </Frame>
                <!-- Action steps with improved visuals -->
                <Frame Padding="16"
                       CornerRadius="8"
                       BorderColor="{AppThemeBinding Light=#e0e0e0, Dark=#333333}"
                       BackgroundColor="{AppThemeBinding Light=White, Dark=#1e1e1e}">
                    <VerticalStackLayout Spacing="8">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Action Steps"
                                   FontAttributes="Bold"
                                   FontSize="18" />
                            <Label Text="{Binding StepCount, StringFormat='{0} steps'}"
                                   Grid.Column="1"
                                   TextColor="{AppThemeBinding Light=#616161, Dark=#b0bec5}"
                                   VerticalOptions="Center" />
                        </Grid>
                        <BoxView HeightRequest="1"
                                 Color="{AppThemeBinding Light=#e0e0e0, Dark=#333333}"
                                 Margin="0,4,0,8" />
                        <CollectionView ItemsSource="{Binding ActionSteps}"
                                        HeightRequest="300">
                            <CollectionView.EmptyView>
                                <Label Text="No steps available"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       TextColor="Gray" />
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <StackLayout>
                                        <!-- Regular Step Template -->
                                        <Grid Padding="4"
                                              ColumnDefinitions="Auto,*,Auto"
                                              ColumnSpacing="12">
                                            <Frame BackgroundColor="{AppThemeBinding Light=#e3f2fd, Dark=#0d47a1}"
                                                   WidthRequest="32"
                                                   HeightRequest="32"
                                                   CornerRadius="16"
                                                   Padding="0"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center">
                                                <Label Text="{Binding Index}"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="Center"
                                                       TextColor="{AppThemeBinding Light=#0d47a1, Dark=White}" />
                                            </Frame>
                                            <VerticalStackLayout Grid.Column="1">
                                                <!-- Different visuals for grouped vs individual actions -->
                                                <Label Text="{Binding Description}"
                                                       VerticalOptions="Center"
                                                       FontAttributes="None"
                                                       TextColor="{AppThemeBinding Light=#212121, Dark=#e0e0e0}" />
                                                <!-- Grouped Item Visualization -->
                                                <Border IsVisible="{Binding IsGrouped}"
                                                        BackgroundColor="{AppThemeBinding Light=#eee8d5, Dark=#073642}"
                                                        StrokeShape="RoundRectangle 6"
                                                        Stroke="{AppThemeBinding Light=#d0c6b1, Dark=#2aa198}"
                                                        StrokeThickness="1"
                                                        Padding="8,6"
                                                        Margin="0,4,0,2">
                                                    <VerticalStackLayout>
                                                        <HorizontalStackLayout Spacing="8">
                                                            <Label Text="{Binding GroupCount, StringFormat='{0} actions grouped'}"
                                                                   FontSize="12"
                                                                   TextColor="{AppThemeBinding Light=#657b83, Dark=#93a1a1}" />
                                                            <Label Text="{Binding GroupType}"
                                                                   FontSize="12"
                                                                   TextColor="{AppThemeBinding Light=#657b83, Dark=#93a1a1}" />
                                                        </HorizontalStackLayout>
                                                        <!-- Visual representation for mouse path -->
                                                        <Border IsVisible="{Binding IsMouseMove}"
                                                                BackgroundColor="{AppThemeBinding Light=#e8f5e9, Dark=#1b5e20}"
                                                                StrokeShape="RoundRectangle 4"
                                                                Padding="8,4"
                                                                Margin="0,4,0,0">
                                                            <VerticalStackLayout>
                                                                <HorizontalStackLayout>
                                                                    <Label Text="Path: "
                                                                           FontSize="11"
                                                                           TextColor="{AppThemeBinding Light=#2e7d32, Dark=#a5d6a7}" />
                                                                    <!-- Fix binding to safely handle null values -->
                                                                    <Label Text="{Binding RawData.Coordinates, StringFormat='({0.X},{0.Y})', TargetNullValue='(0,0)'}"
                                                                           FontSize="11"
                                                                           TextColor="{AppThemeBinding Light=#2e7d32, Dark=#a5d6a7}" />
                                                                    <Label Text=" → "
                                                                           FontSize="11"
                                                                           TextColor="{AppThemeBinding Light=#2e7d32, Dark=#a5d6a7}" />
                                                                    <Label Text="{Binding RawData.DeltaX, StringFormat='({0},', TargetNullValue='(0,'}"
                                                                           FontSize="11"
                                                                           TextColor="{AppThemeBinding Light=#2e7d32, Dark=#a5d6a7}" />
                                                                    <Label Text="{Binding RawData.DeltaY, StringFormat='{0})', TargetNullValue='0)'}"
                                                                           FontSize="11"
                                                                           TextColor="{AppThemeBinding Light=#2e7d32, Dark=#a5d6a7}" />
                                                                </HorizontalStackLayout>
                                                                <BoxView HeightRequest="2"
                                                                         WidthRequest="180"
                                                                         Color="{AppThemeBinding Light=#4caf50, Dark=#81c784}"
                                                                         Margin="10,10,0,0" />
                                                            </VerticalStackLayout>
                                                        </Border>
                                                        <!-- Visual representation for key repetition -->
                                                        <VerticalStackLayout IsVisible="{Binding KeyName, Converter={StaticResource NotNullOrEmptyConverter}}">
                                                            <Border BackgroundColor="{AppThemeBinding Light=#e1f5fe, Dark=#01579b}"
                                                                    StrokeShape="RoundRectangle 4"
                                                                    Padding="8,4"
                                                                    Margin="0,4,0,0">
                                                                <HorizontalStackLayout>
                                                                    <Label Text="Key sequence: "
                                                                           FontSize="11"
                                                                           TextColor="{AppThemeBinding Light=#0288d1, Dark=#81d4fa}" />
                                                                    <Label Text="{Binding KeyName}"
                                                                           FontSize="11"
                                                                           FontAttributes="Bold"
                                                                           TextColor="{AppThemeBinding Light=#0288d1, Dark=#81d4fa}" />
                                                                    <Label Text=" repeated "
                                                                           FontSize="11"
                                                                           TextColor="{AppThemeBinding Light=#0288d1, Dark=#81d4fa}" />
                                                                    <Label Text="{Binding GroupCount}"
                                                                           FontSize="11"
                                                                           FontAttributes="Bold"
                                                                           TextColor="{AppThemeBinding Light=#0288d1, Dark=#81d4fa}" />
                                                                    <Label Text=" times"
                                                                           FontSize="11"
                                                                           TextColor="{AppThemeBinding Light=#0288d1, Dark=#81d4fa}" />
                                                                </HorizontalStackLayout>
                                                            </Border>
                                                        </VerticalStackLayout>
                                                    </VerticalStackLayout>
                                                </Border>
                                                <!-- Individual Mouse Button Events -->
                                                <Grid IsVisible="{Binding IsMouseButton}"
                                                      Margin="0,2,0,0">
                                                    <Border BackgroundColor="{AppThemeBinding Light=#fff3e0, Dark=#3e2723}"
                                                            StrokeShape="RoundRectangle 4"
                                                            Padding="4,2">
                                                        <StackLayout Orientation="Horizontal"
                                                                     Spacing="4">
                                                            <Label Text="{Binding MouseButtonType}"
                                                                   FontSize="11"
                                                                   TextColor="{AppThemeBinding Light=#e65100, Dark=#ffcc80}"
                                                                   FontAttributes="Bold" />
                                                            <Label Text="Button"
                                                                   FontSize="11"
                                                                   TextColor="{AppThemeBinding Light=#e65100, Dark=#ffcc80}" />
                                                            <Label Text="{Binding MouseButtonAction}"
                                                                   FontSize="11"
                                                                   TextColor="{AppThemeBinding Light=#e65100, Dark=#ffcc80}"
                                                                   FontAttributes="Bold" />
                                                        </StackLayout>
                                                    </Border>
                                                </Grid>
                                                <!-- Key Events - Smaller Text -->
                                                <HorizontalStackLayout IsVisible="{Binding KeyName, Converter={StaticResource NotNullOrEmptyConverter}}"
                                                                       Spacing="3"
                                                                       Margin="0,2,0,0">
                                                    <Label Text="Key:"
                                                           FontSize="10"
                                                           TextColor="Gray" />
                                                    <Label Text="{Binding KeyName}"
                                                           FontSize="10"
                                                           FontAttributes="Bold"
                                                           TextColor="Gray" />
                                                    <Label Text="("
                                                           FontSize="10"
                                                           TextColor="Gray" />
                                                    <Label Text="{Binding KeyCode}"
                                                           FontSize="10"
                                                           TextColor="Gray" />
                                                    <Label Text=")"
                                                           FontSize="10"
                                                           TextColor="Gray" />
                                                </HorizontalStackLayout>
                                                <!-- Individual Mouse Movement Details - Smaller -->
                                                <Grid IsVisible="{Binding IsMouseMove}"
                                                      Margin="0,2,0,0">
                                                    <Border BackgroundColor="{AppThemeBinding Light=#e8f5e9, Dark=#1b5e20}"
                                                            StrokeShape="RoundRectangle 4"
                                                            Padding="6,3">
                                                        <VerticalStackLayout Spacing="2">
                                                            <HorizontalStackLayout Spacing="4">
                                                                <Label Text="Mouse Move:"
                                                                       FontSize="10"
                                                                       FontAttributes="Bold"
                                                                       TextColor="{AppThemeBinding Light=#2e7d32, Dark=#a5d6a7}" />
                                                                <Label Text="{Binding RawData.Coordinates, StringFormat='X={0.X}, Y={0.Y}'}"
                                                                       FontSize="10"
                                                                       TextColor="{AppThemeBinding Light=#2e7d32, Dark=#a5d6a7}" />
                                                            </HorizontalStackLayout>
                                                            <HorizontalStackLayout Spacing="4"
                                                                                   IsVisible="{Binding RawData.DeltaX, Converter={StaticResource NotNullOrEmptyConverter}}">
                                                                <Label Text="Delta:"
                                                                       FontSize="9"
                                                                       TextColor="{AppThemeBinding Light=#388e3c, Dark=#81c784}" />
                                                                <Label Text="{Binding RawData.DeltaX, StringFormat='X={0}'}"
                                                                       FontSize="9"
                                                                       TextColor="{AppThemeBinding Light=#388e3c, Dark=#81c784}" />
                                                                <Label Text="{Binding RawData.DeltaY, StringFormat='Y={0}'}"
                                                                       FontSize="9"
                                                                       TextColor="{AppThemeBinding Light=#388e3c, Dark=#81c784}" />
                                                            </HorizontalStackLayout>
                                                        </VerticalStackLayout>
                                                    </Border>
                                                </Grid>
                                                <!-- Timestamp - Even Smaller -->
                                                <Label Text="{Binding Timestamp, StringFormat='{}{0:MM/dd/yyyy HH:mm:ss.fff}'}"
                                                       FontSize="9"
                                                       TextColor="{AppThemeBinding Light=#9e9e9e, Dark=#616161}"
                                                       Margin="0,2,0,0" />
                                            </VerticalStackLayout>
                                            <Label Text="{Binding Duration}"
                                                   Grid.Column="2"
                                                   VerticalOptions="Center"
                                                   TextColor="{AppThemeBinding Light=#616161, Dark=#b0bec5}"
                                                   FontSize="11" />
                                        </Grid>
                                        <!-- Separator between items -->
                                        <BoxView HeightRequest="1"
                                                 Margin="40,4,0,4"
                                                 Color="{AppThemeBinding Light=#f0f0f0, Dark=#333333}"
                                                 IsVisible="{Binding IsGrouped}" />
                                    </StackLayout>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>
                <!-- Associated Models Section -->
                <Frame Padding="16"
                       CornerRadius="8"
                       BorderColor="{AppThemeBinding Light=#e0e0e0, Dark=#333333}"
                       BackgroundColor="{AppThemeBinding Light=White, Dark=#1e1e1e}">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="AI Integration"
                               FontAttributes="Bold"
                               FontSize="18" />
                        <Grid ColumnDefinitions="*,Auto"
                              Margin="0,8,0,8">
                            <Label Text="Include in training data"
                                   VerticalOptions="Center" />
                            <Switch Grid.Column="1"
                                    IsToggled="{Binding IsPartOfTraining}"
                                    OnColor="{AppThemeBinding Light=#4CAF50, Dark=#388E3C}" />
                        </Grid>
                        <Label Text="Assigned Models:"
                               FontAttributes="Bold"
                               Margin="0,8,0,4" />
                        <CollectionView ItemsSource="{Binding AssignedModels}"
                                        HeightRequest="120">
                            <CollectionView.EmptyView>
                                <Label Text="No models assigned to this action"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       TextColor="Gray" />
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="8,4"
                                          ColumnDefinitions="*,Auto"
                                          BackgroundColor="{AppThemeBinding Light=#f5f5f5, Dark=#2a2a2a}"
                                          Margin="0,4">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label Text="{Binding ModelName}"
                                                   FontAttributes="Bold" />
                                            <Label Text="{Binding ModelType}"
                                                   TextColor="Gray"
                                                   FontSize="12" />
                                        </VerticalStackLayout>
                                        <Label Text="{Binding AssignedDate, StringFormat='{0:d}'}"
                                               Grid.Column="1"
                                               VerticalOptions="Center"
                                               TextColor="Gray"
                                               FontSize="12" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        <Button Text="Assign to Model"
                                Command="{Binding AssignToModelCommand}"
                                BackgroundColor="{AppThemeBinding Light=#673AB7, Dark=#512DA8}"
                                TextColor="White"
                                CornerRadius="4"
                                Margin="0,8,0,0" />
                    </VerticalStackLayout>
                </Frame>
                <!-- Files Section -->
                <Frame Padding="16"
                       CornerRadius="8"
                       BorderColor="{AppThemeBinding Light=#e0e0e0, Dark=#333333}"
                       BackgroundColor="{AppThemeBinding Light=White, Dark=#1e1e1e}">
                    <VerticalStackLayout Spacing="8">
                        <Label Text="Attached Files"
                               FontAttributes="Bold"
                               FontSize="18" />
                        <CollectionView ItemsSource="{Binding AttachedFiles}"
                                        HeightRequest="200">
                            <CollectionView.EmptyView>
                                <Label Text="No files attached"
                                       HorizontalOptions="Center"
                                       VerticalOptions="Center"
                                       TextColor="Gray" />
                            </CollectionView.EmptyView>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="8"
                                          ColumnDefinitions="Auto,*"
                                          ColumnSpacing="12">
                                        <Image Source="{Binding FileTypeIcon}"
                                               WidthRequest="40"
                                               HeightRequest="40"
                                               VerticalOptions="Center" />
                                        <StackLayout Grid.Column="1">
                                            <Label Text="{Binding Filename}"
                                                   FontAttributes="Bold"
                                                   FontSize="14" />
                                            <Label Text="{Binding FileType}"
                                                   FontSize="12"
                                                   TextColor="Gray" />
                                            <!-- Conditional UI for file types -->
                                            <ContentView>
                                                <ContentView.Triggers>
                                                    <DataTrigger TargetType="ContentView"
                                                                 Binding="{Binding FileType}"
                                                                 Value="Audio">
                                                        <Setter Property="Content">
                                                            <Setter.Value>
                                                                <Button Text="Play Audio"
                                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type local:ActionDetailPage}}, Path=BindingContext.PlayAudioCommand}"
                                                                        CommandParameter="{Binding Data}" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="ContentView"
                                                                 Binding="{Binding FileType}"
                                                                 Value="Image">
                                                        <Setter Property="Content">
                                                            <Setter.Value>
                                                                <Image Source="{Binding Data}"
                                                                       HeightRequest="100"
                                                                       Aspect="AspectFit" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </DataTrigger>
                                                    <DataTrigger TargetType="ContentView"
                                                                 Binding="{Binding FileType}"
                                                                 Value="Text">
                                                        <Setter Property="Content">
                                                            <Setter.Value>
                                                                <Label Text="{Binding Data}"
                                                                       FontSize="12"
                                                                       TextColor="Gray"
                                                                       LineBreakMode="WordWrap" />
                                                            </Setter.Value>
                                                        </Setter>
                                                    </DataTrigger>
                                                </ContentView.Triggers>
                                            </ContentView>
                                        </StackLayout>
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>
            </VerticalStackLayout>
        </ScrollView>
        <!-- Footer with buttons -->
        <HorizontalStackLayout Grid.Row="2"
                               HorizontalOptions="Center"
                               Spacing="16">
            <Button Text="Back"
                    Command="{Binding BackCommand}"
                    WidthRequest="120"
                    HeightRequest="40"
                    CornerRadius="4"
                    BackgroundColor="{AppThemeBinding Light=#9E9E9E, Dark=#616161}"
                    TextColor="White" />
            <Button Text="Delete"
                    Command="{Binding DeleteCommand}"
                    BackgroundColor="{AppThemeBinding Light=#F44336, Dark=#D32F2F}"
                    TextColor="White"
                    WidthRequest="120"
                    HeightRequest="40"
                    CornerRadius="4" />
        </HorizontalStackLayout>
    </Grid>
</ContentPage>