<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:m="clr-namespace:CSimple.Models"
             xmlns:v="clr-namespace:CSimple.Views"
             xmlns:ios="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.iOSSpecific;assembly=Microsoft.Maui.Controls"
             ios:Page.UseSafeArea="True"
             Shell.NavBarIsVisible="{OnPlatform True, MacCatalyst=False}"
             x:Class="CSimple.Pages.HomePage"
             x:Name="this">
    <ContentPage.MenuBarItems>
        <MenuBarItem Text="File">
            <MenuFlyoutItem Text="Quit"
                            Command="{Binding QuitCommand}" />
        </MenuBarItem>
        <MenuBarItem Text="Edit">
            <MenuFlyoutSubItem Text="Change Location">
                <MenuFlyoutItem Text="Boston, MA" />
                <MenuFlyoutItem Text="Redmond, WA" />
                <MenuFlyoutItem Text="St. Louis, MO" />
            </MenuFlyoutSubItem>
            <MenuFlyoutItem Text="Add a Location"
                            Command="{Binding AddLocationCommand}" />
        </MenuBarItem>
        <MenuBarItem Text="View">
            <MenuFlyoutItem Text="Refresh"
                            Command="{Binding RefreshCommand}" />
            <MenuFlyoutItem Text="Toggle Light/Dark Mode"
                            Command="{Binding ToggleModeCommand}" />
        </MenuBarItem>
    </ContentPage.MenuBarItems>
    <Grid RowDefinitions="Auto,*">
        <!-- AI Assistant Status Bar - Improved Text Visibility -->
        <Frame Grid.Row="0"
               Padding="10"
               BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
               BackgroundColor="{StaticResource BackgroundCard}"
               Margin="15,15,15,0">
            <Grid ColumnDefinitions="Auto,*,Auto">
                <Image Grid.Column="0"
                       Source="ai_icon.png"
                       HeightRequest="32"
                       WidthRequest="32"
                       VerticalOptions="Center" />
                <VerticalStackLayout Grid.Column="1"
                                     Spacing="2"
                                     Margin="10,0">
                    <Label Text="{Binding ActiveAIStatus}"
                           FontAttributes="Bold"
                           TextColor="{StaticResource TextPrimary}"
                           FontSize="16" />
                    <Label Text="{Binding AIStatusDetail}"
                           FontSize="Micro"
                           TextColor="{StaticResource TextSecondary}" />
                </VerticalStackLayout>
                <VerticalStackLayout Grid.Column="2"
                                     Spacing="2">
                    <Switch IsToggled="{Binding IsAIEnabled}"
                            OnColor="{StaticResource Primary}"
                            VerticalOptions="Center" />
                    <Label Text="AI Assistant"
                           FontSize="10"
                           TextColor="{StaticResource TextSecondary}"
                           HorizontalOptions="Center" />
                </VerticalStackLayout>
            </Grid>
        </Frame>
        <ScrollView Grid.Row="1"
                    BackgroundColor="{StaticResource BackgroundPrimary}">
            <VerticalStackLayout Padding="15"
                                 Spacing="20">
                <Label Text="Welcome to CSimple AI"
                       FontSize="Title"
                       TextColor="{StaticResource TextPrimary}"
                       HorizontalOptions="Center" />
                <!-- System Status Dashboard -->
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       BackgroundColor="{StaticResource BackgroundCard}"
                       CornerRadius="10"
                       Padding="15">
                    <VerticalStackLayout Spacing="10">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="System Dashboard"
                                   FontAttributes="Bold"
                                   FontSize="Medium"
                                   VerticalOptions="Center" />
                            <Button Grid.Column="1"
                                    Text="Refresh"
                                    FontSize="Caption"
                                    BackgroundColor="Transparent"
                                    TextColor="{StaticResource Primary}"
                                    Command="{Binding RefreshDashboardCommand}" />
                        </Grid>
                        <Grid ColumnDefinitions="*,*,*"
                              RowDefinitions="Auto,Auto"
                              ColumnSpacing="10"
                              RowSpacing="10">
                            <!-- Active Models -->
                            <Frame Grid.Column="0"
                                   BackgroundColor="{StaticResource PrimaryExtraLight}"
                                   Padding="10"
                                   CornerRadius="5">
                                <VerticalStackLayout HorizontalOptions="Center">
                                    <Label Text="Active Models"
                                           FontSize="Caption"
                                           HorizontalOptions="Center" />
                                    <Label Text="{Binding ActiveModelsCount}"
                                           FontSize="Title"
                                           TextColor="{StaticResource Primary}"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Frame>
                            <!-- Today's Actions -->
                            <Frame Grid.Column="1"
                                   BackgroundColor="{StaticResource TertiaryLight}"
                                   Padding="10"
                                   CornerRadius="5">
                                <VerticalStackLayout HorizontalOptions="Center">
                                    <Label Text="Today's Actions"
                                           FontSize="Caption"
                                           HorizontalOptions="Center" />
                                    <Label Text="{Binding TodayActionsCount}"
                                           FontSize="Title"
                                           TextColor="{StaticResource Tertiary}"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Frame>
                            <!-- Success Rate -->
                            <Frame Grid.Column="2"
                                   BackgroundColor="{StaticResource SecondaryExtraLight}"
                                   Padding="10"
                                   CornerRadius="5">
                                <VerticalStackLayout HorizontalOptions="Center">
                                    <Label Text="Success Rate"
                                           FontSize="Caption"
                                           HorizontalOptions="Center" />
                                    <Label Text="{Binding SuccessRate, StringFormat='{0:P0}'}"
                                           FontSize="Title"
                                           TextColor="{StaticResource Accent}"
                                           HorizontalOptions="Center" />
                                </VerticalStackLayout>
                            </Frame>
                            <!-- System Health -->
                            <Frame Grid.Row="1"
                                   Grid.Column="0"
                                   Grid.ColumnSpan="2"
                                   BackgroundColor="{StaticResource BackgroundSecondary}"
                                   Padding="10"
                                   CornerRadius="5">
                                <Grid ColumnDefinitions="*,Auto"
                                      RowDefinitions="Auto,Auto">
                                    <Label Text="System Health"
                                           FontAttributes="Bold" />
                                    <Label Grid.Row="1"
                                           Text="{Binding SystemHealthStatus}"
                                           TextColor="{StaticResource TextSecondary}"
                                           FontSize="Caption" />
                                    <Label Grid.Column="1"
                                           Text="{Binding SystemHealthPercentage, StringFormat='{0:P0}'}"
                                           TextColor="{Binding SystemHealthColor}"
                                           FontSize="Title"
                                           VerticalOptions="Center" />
                                </Grid>
                            </Frame>
                            <!-- AI Accuracy -->
                            <Frame Grid.Row="1"
                                   Grid.Column="2"
                                   BackgroundColor="{StaticResource BackgroundSecondary}"
                                   Padding="10"
                                   CornerRadius="5">
                                <VerticalStackLayout>
                                    <Label Text="AI Accuracy"
                                           FontAttributes="Bold"
                                           HorizontalOptions="Center" />
                                    <ProgressBar Progress="{Binding AverageAIAccuracy}"
                                                 ProgressColor="{StaticResource Primary}" />
                                    <Label Text="{Binding AverageAIAccuracy, StringFormat='{0:P0}'}"
                                           HorizontalOptions="Center"
                                           FontSize="Caption" />
                                </VerticalStackLayout>
                            </Frame>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>
                <!-- Active Goals Summary Card -->
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       BackgroundColor="{StaticResource BackgroundCard}"
                       CornerRadius="10"
                       Padding="15">
                    <VerticalStackLayout Spacing="15">
                        <Label Text="Active Goals"
                               FontAttributes="Bold"
                               FontSize="Medium" />
                        <!-- Active Goal Cards -->
                        <CollectionView ItemsSource="{Binding ActiveGoals}"
                                        EmptyView="No active goals. Create one to get started!">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame Margin="0,5"
                                           Padding="10"
                                           BorderColor="{StaticResource BorderColor}"
                                           CornerRadius="5">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <VerticalStackLayout Grid.Column="0">
                                                <Label Text="{Binding Name}"
                                                       FontAttributes="Bold" />
                                                <ProgressBar Progress="{Binding Progress}"
                                                             ProgressColor="{StaticResource Primary}" />
                                                <Label Text="{Binding Status}"
                                                       FontSize="Caption"
                                                       TextColor="{StaticResource TextSecondary}" />
                                            </VerticalStackLayout>
                                            <Button Grid.Column="1"
                                                    Text="Continue"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ContinueGoalCommand}"
                                                    CommandParameter="{Binding Id}"
                                                    VerticalOptions="Center"
                                                    BackgroundColor="{StaticResource Primary}"
                                                    TextColor="White" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        <Button Text="Quick Start Goal"
                                Command="{Binding QuickStartGoalCommand}"
                                BackgroundColor="{StaticResource Tertiary}"
                                TextColor="White" />
                    </VerticalStackLayout>
                </Frame>
                <!-- Recent Activity Timeline -->
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       BackgroundColor="{StaticResource BackgroundCard}"
                       CornerRadius="10"
                       Padding="15">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Recent Activity"
                               FontAttributes="Bold"
                               FontSize="Medium" />
                        <CollectionView ItemsSource="{Binding RecentActivities}"
                                        HeightRequest="200"
                                        EmptyView="No recent activity to display">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Grid Padding="0,8"
                                          ColumnDefinitions="Auto,*,Auto">
                                        <Frame Grid.Column="0"
                                               WidthRequest="40"
                                               HeightRequest="40"
                                               CornerRadius="20"
                                               Padding="0"
                                               BackgroundColor="{Binding ActivityColor}"
                                               HorizontalOptions="Center"
                                               VerticalOptions="Start">
                                            <Label Text="{Binding ActivityIcon}"
                                                   HorizontalOptions="Center"
                                                   VerticalOptions="Center"
                                                   FontSize="20"
                                                   TextColor="White" />
                                        </Frame>
                                        <VerticalStackLayout Grid.Column="1"
                                                             Margin="10,0">
                                            <Label Text="{Binding ActivityTitle}"
                                                   FontAttributes="Bold" />
                                            <Label Text="{Binding ActivityDescription}"
                                                   FontSize="Caption"
                                                   TextColor="{StaticResource TextSecondary}" />
                                        </VerticalStackLayout>
                                        <Label Grid.Column="2"
                                               Text="{Binding ActivityTime}"
                                               FontSize="Micro"
                                               TextColor="{StaticResource TextSecondary}"
                                               VerticalOptions="Start" />
                                        <Line Grid.ColumnSpan="3"
                                              X1="20"
                                              Y1="40"
                                              X2="20"
                                              Y2="80"
                                              Stroke="{Binding ActivityColor}"
                                              StrokeThickness="2"
                                              IsVisible="{Binding IsNotLast}" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        <Button Text="View All Activity"
                                Command="{Binding ViewAllActivityCommand}"
                                BackgroundColor="Transparent"
                                TextColor="{StaticResource Primary}"
                                HorizontalOptions="End" />
                    </VerticalStackLayout>
                </Frame>
                <!-- AI Suggestions Card -->
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       BackgroundColor="{StaticResource BackgroundCard}"
                       CornerRadius="10"
                       Padding="15">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Suggestions Based on Your Activity"
                               FontAttributes="Bold"
                               FontSize="Medium" />
                        <CollectionView ItemsSource="{Binding AISuggestions}"
                                        HeightRequest="180">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Horizontal"
                                                   ItemSpacing="10" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame WidthRequest="200"
                                           Padding="10"
                                           BorderColor="{StaticResource BorderColor}"
                                           CornerRadius="5">
                                        <VerticalStackLayout>
                                            <Label Text="{Binding Title}"
                                                   FontAttributes="Bold" />
                                            <Label Text="{Binding Description}"
                                                   FontSize="Caption"
                                                   TextColor="{StaticResource TextSecondary}" />
                                            <Button Text="Apply"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.ApplySuggestionCommand}"
                                                    CommandParameter="{Binding Id}"
                                                    BackgroundColor="{StaticResource Primary}"
                                                    TextColor="White"
                                                    Margin="0,10,0,0" />
                                        </VerticalStackLayout>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                    </VerticalStackLayout>
                </Frame>
                <!-- Scheduled Tasks -->
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       BackgroundColor="{StaticResource BackgroundCard}"
                       CornerRadius="10"
                       Padding="15">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Upcoming Scheduled Tasks"
                               FontAttributes="Bold"
                               FontSize="Medium" />
                        <CollectionView ItemsSource="{Binding ScheduledTasks}"
                                        EmptyView="No scheduled tasks">
                            <CollectionView.ItemTemplate>
                                <DataTemplate>
                                    <Frame Margin="0,5"
                                           Padding="10"
                                           BorderColor="{StaticResource BorderColor}"
                                           CornerRadius="5">
                                        <Grid ColumnDefinitions="Auto,*,Auto">
                                            <Label Grid.Column="0"
                                                   Text="{Binding ScheduledTime}"
                                                   FontAttributes="Bold"
                                                   VerticalOptions="Center"
                                                   WidthRequest="60" />
                                            <VerticalStackLayout Grid.Column="1"
                                                                 Margin="10,0">
                                                <Label Text="{Binding TaskName}"
                                                       FontAttributes="Bold" />
                                                <Label Text="{Binding TaskDescription}"
                                                       FontSize="Caption"
                                                       TextColor="{StaticResource TextSecondary}" />
                                            </VerticalStackLayout>
                                            <Button Grid.Column="2"
                                                    Text="Options"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.TaskOptionsCommand}"
                                                    CommandParameter="{Binding Id}"
                                                    BackgroundColor="Transparent"
                                                    TextColor="{StaticResource Primary}"
                                                    FontSize="Micro" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        <Button Text="Schedule New Task"
                                Command="{Binding ScheduleNewTaskCommand}"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White" />
                    </VerticalStackLayout>
                </Frame>
                <!-- Quick Actions -->
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       BackgroundColor="{StaticResource BackgroundCard}"
                       CornerRadius="10"
                       Padding="15">
                    <Grid ColumnDefinitions="*,*"
                          RowDefinitions="Auto,Auto"
                          ColumnSpacing="10"
                          RowSpacing="10">
                        <Button Grid.Row="0"
                                Grid.Column="0"
                                Text="Record New Action"
                                Command="{Binding NavigateToObserveCommand}"
                                BackgroundColor="{StaticResource Primary}"
                                TextColor="White" />
                        <Button Grid.Row="0"
                                Grid.Column="1"
                                Text="Create New Goal"
                                Command="{Binding CreateNewGoalCommand}"
                                BackgroundColor="{StaticResource Tertiary}"
                                TextColor="White" />
                        <Button Grid.Row="1"
                                Grid.Column="0"
                                Text="Train Model"
                                Command="{Binding TrainModelCommand}"
                                BackgroundColor="{StaticResource Accent}"
                                TextColor="White" />
                        <Button Grid.Row="1"
                                Grid.Column="1"
                                Text="Discover Shared Goals"
                                Command="{Binding DiscoverSharedGoalsCommand}"
                                BackgroundColor="{StaticResource Secondary}"
                                TextColor="White" />
                    </Grid>
                </Frame>
                <!-- FlexLayout for larger screens -->
                <FlexLayout IsVisible="{OnIdiom Phone=False, Default=True}"
                            MinimumHeightRequest="200"
                            AlignItems="Center"
                            JustifyContent="Center">
                    <!-- Activity visualization widget -->
                    <Frame BorderColor="{StaticResource BorderColor}"
                           BackgroundColor="{StaticResource BackgroundCard}"
                           Padding="15"
                           CornerRadius="10"
                           WidthRequest="300">
                        <v:CurrentWidget />
                    </Frame>
                </FlexLayout>
            </VerticalStackLayout>
        </ScrollView>
    </Grid>
</ContentPage>