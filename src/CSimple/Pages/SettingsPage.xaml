<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:CSimple.Resources.Styles"
             xmlns:am="clr-namespace:Microsoft.Maui.ApplicationModel;assembly=Microsoft.Maui.Essentials"
             xmlns:v="clr-namespace:CSimple.Views"
             xmlns:ios="clr-namespace:Microsoft.Maui.Controls.PlatformConfiguration.iOSSpecific;assembly=Microsoft.Maui.Controls"
             ios:Page.UseSafeArea="True"
             Title="Settings"
             Shell.NavBarIsVisible="{OnIdiom True, Desktop=False}"
             x:Class="CSimple.Pages.SettingsPage">
    <ContentPage.Resources>
        <ControlTemplate x:Key="ThemeRadioTemplate">
            <Frame BorderColor="{StaticResource Background_Mid}"
                   BackgroundColor="Transparent"
                   HasShadow="False"
                   HeightRequest="120"
                   WidthRequest="100"
                   HorizontalOptions="Start"
                   VerticalOptions="Start"
                   Padding="0">
                <VisualStateManager.VisualStateGroups>
                    <VisualStateGroupList>
                        <VisualStateGroup x:Name="CheckedStates">
                            <VisualState x:Name="Checked">
                                <VisualState.Setters>
                                    <Setter Property="BorderColor"
                                            Value="{StaticResource Primary}" />
                                    <Setter TargetName="Check"
                                            Property="Opacity"
                                            Value="1" />
                                </VisualState.Setters>
                            </VisualState>
                            <VisualState x:Name="Unchecked">
                                <VisualState.Setters>
                                    <Setter Property="BorderColor"
                                            Value="{StaticResource Background_Mid}" />
                                    <Setter TargetName="Check"
                                            Property="Opacity"
                                            Value="0" />
                                </VisualState.Setters>
                            </VisualState>
                        </VisualStateGroup>
                    </VisualStateGroupList>
                </VisualStateManager.VisualStateGroups>
                <Grid>
                    <Grid WidthRequest="18"
                          HeightRequest="18"
                          Margin="0,8,8,0"
                          HorizontalOptions="End"
                          VerticalOptions="Start">
                        <Ellipse Stroke="{StaticResource DarkGray}"
                                 WidthRequest="16"
                                 HeightRequest="16"
                                 StrokeThickness="0.5"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center"
                                 Fill="White" />
                        <Ellipse x:Name="Check"
                                 WidthRequest="8"
                                 HeightRequest="8"
                                 Stroke="{StaticResource Primary}"
                                 Fill="{StaticResource Primary}"
                                 VerticalOptions="Center"
                                 HorizontalOptions="Center" />
                    </Grid>
                    <ContentPresenter />
                </Grid>
            </Frame>
        </ControlTemplate>
    </ContentPage.Resources>
    <Grid ColumnDefinitions="*"
          RowDefinitions="{OnIdiom Phone='100,*', Default='100,*,0'}">
        <ScrollView Grid.Row="1"
                    Margin="{OnIdiom Phone=15, Default=25}">
            <VerticalStackLayout Spacing="8">
                <!-- App Title and Description -->
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       BackgroundColor="{AppThemeBinding Light={StaticResource CardBackgroundLight}, Dark={StaticResource CardBackgroundDark}}"
                       CornerRadius="10"
                       Padding="20"
                       Margin="0,0,0,10">
                    <Grid ColumnDefinitions="Auto,*"
                          ColumnSpacing="15">
                        <Image Grid.Column="0"
                               Source="csimple_logo_png.png"
                               HeightRequest="60"
                               WidthRequest="60"
                               VerticalOptions="Start"
                               HorizontalOptions="Start" />
                        <VerticalStackLayout Grid.Column="1"
                                             Spacing="8">
                            <Label Text="Settings - CSimple by Simple Inc"
                                   FontSize="24"
                                   FontAttributes="Bold"
                                   TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}"
                                   HorizontalOptions="Start" />
                            <Label x:Name="AppVersionLabel"
                                   Text="Version Loading..."
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                   HorizontalOptions="Start" />
                            <Label Text="Configure your AI assistant settings and preferences to customize your experience."
                                   FontSize="14"
                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                   HorizontalOptions="Start"
                                   HorizontalTextAlignment="Start"
                                   LineBreakMode="WordWrap" />
                        </VerticalStackLayout>
                    </Grid>
                </Frame>
                <Label Text="Account"
                       class="SectionTitle" />
                <StackLayout x:Name="AccountSection"
                             Padding="10"
                             Style="{StaticResource AccountSectionStyle}">
                    <StackLayout Padding="10">
                        <Label Text="Email"
                               class="Subhead" />
                        <Label x:Name="UserEmailLabel"
                               Text="user@example.com"
                               class="SubContent" />
                        <Button Text="Edit Email"
                                Command="{Binding EditEmailCommand}" />
                    </StackLayout>
                    <BoxView class="HRule" />
                    <StackLayout Padding="10">
                        <Label Text="Password"
                               class="Subhead" />
                        <Label Text="********"
                               x:Name="PasswordLabel"
                               class="SubContent" />
                        <Button x:Name="ResetPasswordButton"
                                Text="🔐 Reset Password"
                                Clicked="ResetPassword_Clicked"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SecondaryDark}}"
                                TextColor="White"
                                CornerRadius="8"
                                Padding="15,8"
                                HorizontalOptions="Start" />
                    </StackLayout>
                </StackLayout>
                <BoxView class="HRule" />
                <!-- Membership Section - New section -->
                <Label Text="Membership"
                       class="SectionTitle" />
                <Frame Padding="10"
                       BorderColor="{StaticResource Background_Mid}"
                       BackgroundColor="Transparent">
                    <VerticalStackLayout Spacing="10">
                        <Grid ColumnDefinitions="*,Auto">
                            <Label Text="Current Plan"
                                   class="Subhead"
                                   Grid.Column="0" />
                            <Label x:Name="MembershipTierLabel"
                                   Text="Free"
                                   Grid.Column="1"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}" />
                        </Grid>
                        <BoxView class="HRule"
                                 Margin="0,5" />
                        <Label Text="API Usage &amp; Limits"
                               class="Subhead" />
                        <!-- Usage Overview Grid -->
                        <Grid RowDefinitions="Auto,Auto"
                              ColumnDefinitions="*,*"
                              ColumnSpacing="10"
                              RowSpacing="10"
                              Margin="0,5">
                            <!-- Current Usage -->
                            <Frame Grid.Row="0"
                                   Grid.Column="0"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource PrimaryExtraLight}, Dark={StaticResource PrimaryDark}}"
                                   CornerRadius="8"
                                   Padding="10"
                                   HasShadow="False">
                                <StackLayout Spacing="5">
                                    <Label Text="💰 Current Usage"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                    <Label x:Name="CurrentUsageLabel"
                                           Text="$0.0000"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}" />
                                </StackLayout>
                            </Frame>
                            <!-- Monthly Limit -->
                            <Frame Grid.Row="0"
                                   Grid.Column="1"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource SecondaryExtraLight}, Dark={StaticResource SecondaryDark}}"
                                   CornerRadius="8"
                                   Padding="10"
                                   HasShadow="False">
                                <StackLayout Spacing="5">
                                    <Label Text="🎯 Monthly Limit"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                    <Label x:Name="MonthlyLimitLabel"
                                           Text="$10.00"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SecondaryLight}}" />
                                </StackLayout>
                            </Frame>
                            <!-- Remaining Balance -->
                            <Frame Grid.Row="1"
                                   Grid.Column="0"
                                   BackgroundColor="{AppThemeBinding Light=#E8F5E8, Dark=#2D4A2D}"
                                   CornerRadius="8"
                                   Padding="10"
                                   HasShadow="False">
                                <StackLayout Spacing="5">
                                    <Label Text="💸 Remaining"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                    <Label x:Name="RemainingBalanceLabel"
                                           Text="$10.0000"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=#2E7D32, Dark=#4CAF50}" />
                                </StackLayout>
                            </Frame>
                            <!-- Usage Percentage -->
                            <Frame Grid.Row="1"
                                   Grid.Column="1"
                                   BackgroundColor="{AppThemeBinding Light=#F3E5F5, Dark=#4A2C4A}"
                                   CornerRadius="8"
                                   Padding="10"
                                   HasShadow="False">
                                <StackLayout Spacing="5">
                                    <Label Text="📊 Usage %"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                    <Label x:Name="UsagePercentageLabel"
                                           Text="0.0%"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=#7B1FA2, Dark=#BA68C8}" />
                                </StackLayout>
                            </Frame>
                        </Grid>
                        <!-- Usage Progress Bar -->
                        <StackLayout x:Name="UsageProgressContainer"
                                     Spacing="8"
                                     Margin="0,10,0,0"
                                     IsVisible="False">
                            <Label Text="Usage Progress"
                                   FontSize="14"
                                   FontAttributes="Bold" />
                            <Frame BackgroundColor="{AppThemeBinding Light={StaticResource Background_Light}, Dark={StaticResource Background_Dark}}"
                                   CornerRadius="10"
                                   Padding="2"
                                   HasShadow="False">
                                <Frame x:Name="UsageProgressBar"
                                       BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}"
                                       CornerRadius="8"
                                       HeightRequest="16"
                                       HorizontalOptions="Start"
                                       HasShadow="False"
                                       WidthRequest="0" />
                            </Frame>
                            <Label x:Name="UsageStatusLabel"
                                   Text="✅ Good"
                                   FontSize="12"
                                   HorizontalOptions="Center" />
                        </StackLayout>
                        <!-- Recent API Usage -->
                        <StackLayout x:Name="RecentUsageContainer"
                                     Spacing="8"
                                     Margin="0,15,0,0"
                                     IsVisible="False">
                            <Label Text="Recent API Usage"
                                   FontSize="14"
                                   FontAttributes="Bold" />
                            <CollectionView x:Name="RecentUsageList"
                                            HeightRequest="150">
                                <CollectionView.ItemsLayout>
                                    <LinearItemsLayout Orientation="Vertical"
                                                       ItemSpacing="5" />
                                </CollectionView.ItemsLayout>
                                <CollectionView.ItemTemplate>
                                    <DataTemplate>
                                        <Frame BackgroundColor="{AppThemeBinding Light={StaticResource CardBackgroundLight}, Dark={StaticResource CardBackgroundDark}}"
                                               CornerRadius="8"
                                               Padding="10"
                                               Margin="0,2"
                                               HasShadow="False">
                                            <Grid ColumnDefinitions="*,Auto"
                                                  ColumnSpacing="10">
                                                <StackLayout Grid.Column="0"
                                                             Spacing="2">
                                                    <Label Text="{Binding ApiDisplayName}"
                                                           FontSize="13"
                                                           FontAttributes="Bold" />
                                                    <Label Text="{Binding Date}"
                                                           FontSize="11"
                                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                                </StackLayout>
                                                <StackLayout Grid.Column="1"
                                                             Spacing="2">
                                                    <Label Text="{Binding Usage}"
                                                           FontSize="11"
                                                           HorizontalTextAlignment="End"
                                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                                    <Label Text="{Binding Cost}"
                                                           FontSize="13"
                                                           FontAttributes="Bold"
                                                           HorizontalTextAlignment="End" />
                                                </StackLayout>
                                            </Grid>
                                        </Frame>
                                    </DataTemplate>
                                </CollectionView.ItemTemplate>
                            </CollectionView>
                        </StackLayout>
                        <!-- Upgrade Prompt for Free Users -->
                        <Frame x:Name="UpgradePromptFrame"
                               BackgroundColor="{AppThemeBinding Light=#FFF3E0, Dark=#3E2723}"
                               CornerRadius="10"
                               Padding="15"
                               Margin="0,15,0,0"
                               IsVisible="False"
                               HasShadow="False">
                            <Grid ColumnDefinitions="Auto,*,Auto"
                                  ColumnSpacing="15">
                                <Label Grid.Column="0"
                                       Text="🚀"
                                       FontSize="32"
                                       VerticalOptions="Center" />
                                <StackLayout Grid.Column="1"
                                             Spacing="5">
                                    <Label Text="Upgrade to Flex or Premium"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}" />
                                    <Label Text="Get $10 monthly API usage allowance and access to AI-powered features!"
                                           FontSize="14"
                                           LineBreakMode="WordWrap"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                </StackLayout>
                                <Button Grid.Column="2"
                                        Text="Upgrade Now"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                        TextColor="White"
                                        CornerRadius="8"
                                        Padding="15,8"
                                        Clicked="UpgradePlan_Clicked" />
                            </Grid>
                        </Frame>
                        <!-- Legacy Stats for Backward Compatibility -->
                        <StackLayout x:Name="LegacyStatsContainer"
                                     Spacing="5"
                                     Margin="0,15,0,0"
                                     IsVisible="False">
                            <Label Text="System Statistics"
                                   FontSize="14"
                                   FontAttributes="Bold" />
                            <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                                  ColumnDefinitions="*,Auto">
                                <Label Text="Model Processing Time"
                                       Grid.Row="0"
                                       Grid.Column="0" />
                                <Label x:Name="ProcessingTimeLabel"
                                       Text="0 minutes"
                                       Grid.Row="0"
                                       Grid.Column="1" />
                                <Label Text="API Calls"
                                       Grid.Row="1"
                                       Grid.Column="0" />
                                <Label x:Name="ApiCallsLabel"
                                       Text="0 / 100"
                                       Grid.Row="1"
                                       Grid.Column="1" />
                                <Label Text="Storage Used"
                                       Grid.Row="2"
                                       Grid.Column="0" />
                                <Label x:Name="StorageLabel"
                                       Text="0 MB / 500 MB"
                                       Grid.Row="2"
                                       Grid.Column="1" />
                                <Label Text="Billing Cycle"
                                       Grid.Row="3"
                                       Grid.Column="0" />
                                <Label x:Name="BillingCycleLabel"
                                       Text="N/A"
                                       Grid.Row="3"
                                       Grid.Column="1" />
                            </Grid>
                        </StackLayout>
                        <BoxView class="HRule"
                                 Margin="0,5" />
                        <Label Text="Membership Benefits"
                               class="Subhead" />
                        <StackLayout>
                            <Label x:Name="MembershipFeaturesLabel"
                                   Text="• Limited access to basic features&#xA;• 100 API calls per month&#xA;• 500 MB storage" />
                        </StackLayout>
                        <BoxView class="HRule"
                                 Margin="0,5" />
                        <Button x:Name="UpgradePlanButton"
                                Text="Upgrade Plan"
                                Clicked="UpgradePlan_Clicked"
                                HorizontalOptions="Start" />
                        <Button x:Name="ViewBillingButton"
                                Text="View Billing History"
                                Clicked="ViewBilling_Clicked"
                                HorizontalOptions="Start" />
                        <!-- Debug button - remove once membership issue is resolved -->
                        <Button x:Name="RefreshMembershipButton"
                                Text="🔄 Refresh Membership"
                                Clicked="RefreshMembership_Clicked"
                                HorizontalOptions="Start"
                                BackgroundColor="Orange"
                                TextColor="White" />
                        <!-- Refresh Usage Button -->
                        <Button x:Name="RefreshUsageButton"
                                Text="🔄 Refresh Usage Data"
                                Clicked="RefreshUsage_Clicked"
                                HorizontalOptions="Start"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SecondaryDark}}"
                                TextColor="White"
                                Margin="0,5" />
                    </VerticalStackLayout>
                </Frame>
                <BoxView class="HRule" />
                <!-- Storage Section -->
                <Label Text="💾 Database Storage"
                       class="SectionTitle" />
                <Frame Padding="10"
                       BorderColor="{StaticResource Background_Mid}"
                       BackgroundColor="Transparent">
                    <VerticalStackLayout x:Name="StorageSection"
                                         Spacing="10">
                        <!-- Storage Overview Grid -->
                        <Grid RowDefinitions="Auto,Auto"
                              ColumnDefinitions="*,*"
                              ColumnSpacing="10"
                              RowSpacing="10">
                            <!-- Total Used -->
                            <Frame Grid.Row="0"
                                   Grid.Column="0"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource PrimaryExtraLight}, Dark={StaticResource PrimaryDark}}"
                                   CornerRadius="8"
                                   Padding="10"
                                   HasShadow="False">
                                <StackLayout Spacing="5">
                                    <Label Text="📊 Total Used"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                    <Label x:Name="StorageTotalUsedLabel"
                                           Text="0 B"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}" />
                                </StackLayout>
                            </Frame>
                            <!-- Storage Limit -->
                            <Frame Grid.Row="0"
                                   Grid.Column="1"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource SecondaryExtraLight}, Dark={StaticResource SecondaryDark}}"
                                   CornerRadius="8"
                                   Padding="10"
                                   HasShadow="False">
                                <StackLayout Spacing="5">
                                    <Label Text="🎯 Storage Limit"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                    <Label x:Name="StorageLimitLabel"
                                           Text="10 MB"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SecondaryLight}}" />
                                </StackLayout>
                            </Frame>
                            <!-- Total Items -->
                            <Frame Grid.Row="1"
                                   Grid.Column="0"
                                   BackgroundColor="{AppThemeBinding Light=#E8F5E8, Dark=#2D4A2D}"
                                   CornerRadius="8"
                                   Padding="10"
                                   HasShadow="False">
                                <StackLayout Spacing="5">
                                    <Label Text="📁 Total Items"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                    <Label x:Name="StorageItemCountLabel"
                                           Text="0"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=#2E7D32, Dark=#4CAF50}" />
                                </StackLayout>
                            </Frame>
                            <!-- Files Stored -->
                            <Frame Grid.Row="1"
                                   Grid.Column="1"
                                   BackgroundColor="{AppThemeBinding Light=#F3E5F5, Dark=#4A2C4A}"
                                   CornerRadius="8"
                                   Padding="10"
                                   HasShadow="False">
                                <StackLayout Spacing="5">
                                    <Label Text="📄 Files Stored"
                                           FontSize="12"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                    <Label x:Name="StorageFileCountLabel"
                                           Text="0"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=#7B1FA2, Dark=#BA68C8}" />
                                </StackLayout>
                            </Frame>
                        </Grid>
                        <!-- Storage Progress Bar -->
                        <StackLayout x:Name="StorageProgressContainer"
                                     Spacing="8"
                                     Margin="0,10,0,0"
                                     IsVisible="False">
                            <Label Text="Storage Progress"
                                   FontSize="14"
                                   FontAttributes="Bold" />
                            <Frame BackgroundColor="{AppThemeBinding Light={StaticResource Background_Light}, Dark={StaticResource Background_Dark}}"
                                   CornerRadius="10"
                                   Padding="2"
                                   HasShadow="False">
                                <Frame x:Name="StorageProgressBar"
                                       BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryLight}}"
                                       CornerRadius="8"
                                       HeightRequest="16"
                                       HorizontalOptions="Start"
                                       HasShadow="False"
                                       WidthRequest="0" />
                            </Frame>
                            <Label x:Name="StorageStatusLabel"
                                   Text="✅ Good"
                                   FontSize="12"
                                   HorizontalOptions="Center" />
                        </StackLayout>
                        <!-- Storage warnings -->
                        <Frame x:Name="StorageWarningFrame"
                               BackgroundColor="{AppThemeBinding Light=#FFEBEE, Dark=#4A2D2D}"
                               CornerRadius="10"
                               Padding="15"
                               Margin="0,10,0,0"
                               IsVisible="False"
                               HasShadow="False">
                            <Grid ColumnDefinitions="Auto,*"
                                  ColumnSpacing="10">
                                <Label x:Name="StorageWarningIcon"
                                       Grid.Column="0"
                                       Text="⚠️"
                                       FontSize="24"
                                       VerticalOptions="Center" />
                                <StackLayout Grid.Column="1"
                                             Spacing="5">
                                    <Label x:Name="StorageWarningTitle"
                                           Text="Storage Nearly Full"
                                           FontSize="16"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light=#D32F2F, Dark=#F44336}" />
                                    <Label x:Name="StorageWarningMessage"
                                           Text="You're using most of your storage limit."
                                           FontSize="14"
                                           LineBreakMode="WordWrap"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}" />
                                </StackLayout>
                            </Grid>
                        </Frame>
                    </VerticalStackLayout>
                </Frame>
                <BoxView class="HRule" />
                <!-- AI Features Section - New section -->
                <Label Text="AI Assistant Features"
                       class="SectionTitle" />
                <Frame Padding="10"
                       BorderColor="{StaticResource Background_Mid}"
                       BackgroundColor="Transparent">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Active Neural Network Mode"
                               class="Subhead" />
                        <Picker x:Name="ModelPicker"
                                Title="Select Model"
                                SelectedIndexChanged="ModelPicker_SelectedIndexChanged" />
                        <BoxView class="HRule"
                                 Margin="0,5" />
                        <Label Text="System Access Permissions"
                               class="Subhead" />
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto,Auto,Auto"
                              ColumnDefinitions="*,Auto">
                            <Label Text="Screen Capture"
                                   Grid.Row="0"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="ScreenCaptureSwitch"
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    Toggled="Permission_Toggled" />
                            <Label Text="Audio Capture"
                                   Grid.Row="1"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="AudioCaptureSwitch"
                                    Grid.Row="1"
                                    Grid.Column="1"
                                    Toggled="Permission_Toggled" />
                            <Label Text="Keyboard Simulation"
                                   Grid.Row="2"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="KeyboardSimulationSwitch"
                                    Grid.Row="2"
                                    Grid.Column="1"
                                    Toggled="Permission_Toggled" />
                            <Label Text="Mouse Simulation"
                                   Grid.Row="3"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="MouseSimulationSwitch"
                                    Grid.Row="3"
                                    Grid.Column="1"
                                    Toggled="Permission_Toggled" />
                            <Label Text="Voice Output"
                                   Grid.Row="4"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="VoiceOutputSwitch"
                                    Grid.Row="4"
                                    Grid.Column="1"
                                    Toggled="Permission_Toggled" />
                            <Label Text="System Commands"
                                   Grid.Row="5"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="SystemCommandsSwitch"
                                    Grid.Row="5"
                                    Grid.Column="1"
                                    Toggled="Permission_Toggled" />
                        </Grid>
                        <BoxView class="HRule"
                                 Margin="0,5" />
                        <Label Text="Feature Modules"
                               class="Subhead" />
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                              ColumnDefinitions="*,Auto">
                            <Label Text="Observe Mode"
                                   Grid.Row="0"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="ObserveModeSwitch"
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    Toggled="FeatureMode_Toggled" />
                            <Label Text="Orient Mode"
                                   Grid.Row="1"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="OrientModeSwitch"
                                    Grid.Row="1"
                                    Grid.Column="1"
                                    Toggled="FeatureMode_Toggled" />
                            <Label Text="Plan Mode"
                                   Grid.Row="2"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="PlanModeSwitch"
                                    Grid.Row="2"
                                    Grid.Column="1"
                                    Toggled="FeatureMode_Toggled" />
                            <Label Text="Action Mode"
                                   Grid.Row="3"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="ActionModeSwitch"
                                    Grid.Row="3"
                                    Grid.Column="1"
                                    Toggled="FeatureMode_Toggled" />
                        </Grid>
                        <BoxView class="HRule"
                                 Margin="0,5" />
                        <Label Text="Intelligence Settings"
                               class="Subhead" />
                        <Grid RowDefinitions="Auto,Auto,Auto,Auto"
                              ColumnDefinitions="*,Auto">
                            <Label Text="Minimum Intelligence Interval (ms)"
                                   Grid.Row="0"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Entry x:Name="IntelligenceIntervalEntry"
                                   Grid.Row="0"
                                   Grid.Column="1"
                                   Text="1000"
                                   Keyboard="Numeric"
                                   WidthRequest="100"
                                   TextChanged="IntelligenceInterval_TextChanged"
                                   Placeholder="1000" />
                            <Label Text="Initial Delay Before First Execution (ms)"
                                   Grid.Row="1"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Entry x:Name="IntelligenceInitialDelayEntry"
                                   Grid.Row="1"
                                   Grid.Column="1"
                                   Text="5000"
                                   Keyboard="Numeric"
                                   WidthRequest="100"
                                   TextChanged="IntelligenceInitialDelay_TextChanged"
                                   Placeholder="5000" />
                            <Label Text="Auto-execute Intelligence Pipeline"
                                   Grid.Row="2"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="IntelligenceAutoExecutionSwitch"
                                    Grid.Row="2"
                                    Grid.Column="1"
                                    IsToggled="True"
                                    Toggled="IntelligenceAutoExecution_Toggled" />
                            <Label Text="Controls intelligence processing timing and visual data capture delay. Initial delay allows sufficient time for screenshots and webcam data to be captured before first pipeline execution."
                                   Grid.Row="3"
                                   Grid.ColumnSpan="2"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                   Margin="0,5,0,0" />
                        </Grid>
                        <BoxView class="HRule"
                                 Margin="0,5" />
                        <Label Text="Model Management"
                               class="Subhead" />
                        <HorizontalStackLayout Spacing="10">
                            <Button Text="Import Model"
                                    Clicked="ImportModel_Clicked" />
                            <Button Text="Export Model"
                                    Clicked="ExportModel_Clicked" />
                        </HorizontalStackLayout>
                    </VerticalStackLayout>
                </Frame>
                <BoxView class="HRule" />
                <!-- Model Compatibility Section -->
                <Label Text="Model Compatibility &amp; Auto-Selection"
                       class="SectionTitle" />
                <Frame Padding="10"
                       BorderColor="{StaticResource Background_Mid}"
                       BackgroundColor="Transparent">
                    <VerticalStackLayout Spacing="10">
                        <Label Text="Auto-Model Selection"
                               class="Subhead" />
                        <Grid RowDefinitions="Auto,Auto"
                              ColumnDefinitions="*,Auto">
                            <Label Text="Enable Auto-Select Model on Startup"
                                   Grid.Row="0"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="AutoSelectModelSwitch"
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    Toggled="OnModelCompatSettingChanged" />
                            <Label Text="Automatically chooses optimal model based on hardware capabilities"
                                   Grid.Row="1"
                                   Grid.ColumnSpan="2"
                                   FontSize="12"
                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondaryLight}, Dark={StaticResource TextSecondaryDark}}"
                                   Margin="0,5,0,0" />
                        </Grid>
                        <BoxView class="HRule"
                                 Margin="0,5" />
                        <Label Text="Hardware Capabilities"
                               class="Subhead" />
                        <Grid RowDefinitions="Auto,Auto,Auto"
                              ColumnDefinitions="*,Auto">
                            <Label Text="GPU Capability"
                                   Grid.Row="0"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Picker x:Name="GpuCapabilityPicker"
                                    Grid.Row="0"
                                    Grid.Column="1"
                                    SelectedIndexChanged="OnModelCompatSettingChanged"
                                    WidthRequest="180" />
                            <Label Text="Max VRAM (GB)"
                                   Grid.Row="1"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Entry x:Name="MaxVramEntry"
                                   Grid.Row="1"
                                   Grid.Column="1"
                                   Keyboard="Numeric"
                                   Completed="OnModelCompatSettingChanged" />
                            <Label Text="Allow Large Models"
                                   Grid.Row="2"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch x:Name="AllowLargeModelsSwitch"
                                    Grid.Row="2"
                                    Grid.Column="1"
                                    Toggled="OnModelCompatSettingChanged" />
                        </Grid>
                        <BoxView class="HRule"
                                 Margin="0,5" />
                        <Label Text="Recommended Model Preview"
                               class="Subhead" />
                        <Frame BackgroundColor="{AppThemeBinding Light={StaticResource PrimaryExtraLight}, Dark={StaticResource PrimaryDark}}"
                               Padding="10"
                               CornerRadius="5">
                            <Label x:Name="RecommendedModelLabel"
                                   Text="General Assistant"
                                   FontAttributes="Bold"
                                   TextColor="{StaticResource Primary}" />
                        </Frame>
                    </VerticalStackLayout>
                </Frame>
                <BoxView class="HRule" />
                <Label Text="App"
                       class="SectionTitle" />
                <Grid Padding="10">
                    <Label Text="Theme"
                           class="Subhead" />
                    <StackLayout HorizontalOptions="End"
                                 Spacing="12"
                                 Orientation="Horizontal"
                                 RadioButtonGroup.GroupName="AppTheme"
                                 RadioButtonGroup.SelectedValue="{Binding SelectedTheme}">
                        <StackLayout.Resources>
                            <Style TargetType="RadioButton">
                                <Setter Property="ControlTemplate"
                                        Value="{StaticResource ThemeRadioTemplate}" />
                            </Style>
                        </StackLayout.Resources>
                        <RadioButton Value="{x:Static am:AppTheme.Unspecified}"
                                     IsChecked="True"
                                     CheckedChanged="RadioButton_CheckedChanged">
                            <RadioButton.Content>
                                <Grid RowDefinitions="*">
                                    <Image VerticalOptions="Center"
                                           HorizontalOptions="Center"
                                           WidthRequest="50"
                                           HeightRequest="50"
                                           Margin="0,-8,0,0"
                                           Source="{FontImage FontFamily=FontAwesome, Glyph={x:Static local:IconFont.Mobile}, Color={StaticResource MidGray}, Size=42}" />
                                    <Label Text="Default"
                                           VerticalOptions="End"
                                           HorizontalOptions="Center"
                                           FontSize="12"
                                           Margin="0,0,0,10" />
                                </Grid>
                            </RadioButton.Content>
                        </RadioButton>
                        <RadioButton Value="{x:Static am:AppTheme.Dark}"
                                     CheckedChanged="RadioButton_CheckedChanged">
                            <RadioButton.Content>
                                <Grid RowDefinitions="*">
                                    <Image VerticalOptions="Center"
                                           HorizontalOptions="Center"
                                           WidthRequest="50"
                                           HeightRequest="50"
                                           Margin="0,-8,0,0"
                                           Source="{FontImage FontFamily=FontAwesome, Glyph={x:Static local:IconFont.Lightbulb}, Color=Black, Size=42}" />
                                    <Label Text="Dark"
                                           VerticalOptions="End"
                                           Margin="0,0,0,10"
                                           HorizontalOptions="Center"
                                           FontSize="12" />
                                </Grid>
                            </RadioButton.Content>
                        </RadioButton>
                        <RadioButton Value="{x:Static am:AppTheme.Light}"
                                     CheckedChanged="RadioButton_CheckedChanged">
                            <RadioButton.Content>
                                <Grid RowDefinitions="*">
                                    <Image VerticalOptions="Center"
                                           HorizontalOptions="Center"
                                           WidthRequest="50"
                                           HeightRequest="50"
                                           Margin="0,-8,0,0"
                                           Source="{FontImage FontFamily=FontAwesome, Glyph={x:Static local:IconFont.Lightbulb}, Color=White, Size=42}" />
                                    <Label Text="Light"
                                           FontSize="12"
                                           VerticalOptions="End"
                                           HorizontalOptions="Center"
                                           Margin="0,0,0,10" />
                                </Grid>
                            </RadioButton.Content>
                        </RadioButton>
                    </StackLayout>
                </Grid>
                <BoxView class="HRule" />
                <Picker x:Name="TimeZonePicker"
                        Title="Select Time Zone"
                        SelectedIndexChanged="TimeZonePicker_SelectedIndexChanged" />
                <BoxView class="HRule" />
                <!-- Application Paths Section -->
                <Label Text="Application Paths"
                       class="SectionTitle" />
                <Frame Padding="10"
                       BorderColor="{StaticResource Background_Mid}"
                       BackgroundColor="Transparent">
                    <VerticalStackLayout Spacing="15">
                        <!-- Current Base Path Display -->
                        <StackLayout>
                            <Label Text="Current Application Folder:"
                                   FontAttributes="Bold"
                                   Margin="0,0,0,5" />
                            <Label x:Name="CurrentBasePathLabel"
                                   Text="{Binding CurrentBasePath, FallbackValue='C:\\Users\\[User]\\Documents\\CSimple'}"
                                   TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                                   Margin="10,0,0,0" />
                        </StackLayout>
                        <!-- Change Base Path Button -->
                        <Button x:Name="ChangeBasePathButton"
                                Text="Change Application Folder"
                                Clicked="OnChangeBasePathClicked"
                                HorizontalOptions="Start"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                TextColor="White"
                                Margin="0,5,0,10" />
                        <!-- Path Details -->
                        <StackLayout>
                            <Label Text="Folder Structure:"
                                   FontAttributes="Bold"
                                   Margin="0,0,0,5" />
                            <StackLayout x:Name="PathDetailsContainer"
                                         Margin="10,0,0,0"
                                         Spacing="2">
                                <!-- Paths will be populated dynamically -->
                            </StackLayout>
                        </StackLayout>
                        <!-- Reset to Default Button -->
                        <Button x:Name="ResetPathsButton"
                                Text="Reset to Default Location"
                                Clicked="OnResetPathsClicked"
                                HorizontalOptions="Start"
                                BackgroundColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SecondaryDark}}"
                                TextColor="White"
                                Margin="0,5,0,0" />
                    </VerticalStackLayout>
                </Frame>
                <BoxView class="HRule" />
                <!-- Developer Settings Section -->
                <Label Text="Developer Settings"
                       class="Subhead" />
                <Grid RowDefinitions="Auto,Auto"
                      ColumnDefinitions="*,Auto"
                      Padding="10,5">
                    <Label Text="Debug Console"
                           Grid.Row="0"
                           Grid.Column="0"
                           VerticalOptions="Center" />
                    <Switch x:Name="DebugConsoleSwitch"
                            Grid.Row="0"
                            Grid.Column="1"
                            Toggled="DebugConsoleSwitch_Toggled"
                            IsToggled="False" />
                    <Label Text="Show debug console window for real-time logging"
                           Grid.Row="1"
                           Grid.ColumnSpan="2"
                           FontSize="12"
                           TextColor="{StaticResource MidGray}"
                           Margin="0,0,0,5" />
                </Grid>
                <BoxView class="HRule" />
                <Label Grid.Row="0"
                       Text="Support"
                       class="Subhead">
                    <Label.GestureRecognizers>
                        <TapGestureRecognizer Tapped="OnSupportTapped" />
                    </Label.GestureRecognizers>
                </Label>
                <BoxView class="HRule" />
            </VerticalStackLayout>
        </ScrollView>
        <Grid Grid.Row="0"
              Grid.ColumnDefinitions="16,75,16,*,100,16">
            <Image HorizontalOptions="Center"
                   VerticalOptions="Center"
                   Grid.Column="1"
                   WidthRequest="75"
                   HeightRequest="75"
                   Aspect="AspectFill"
                   Source="https://sthopwood.com/static/media/Checkmark512.44b03091d831e2a87a74.png">
                <Image.Clip>
                    <EllipseGeometry Center="36,36"
                                     RadiusX="36"
                                     RadiusY="36" />
                </Image.Clip>
            </Image>
            <Label x:Name="UserNicknameLabel"
                   Text="No user"
                   Grid.Column="3"
                   LineBreakMode="WordWrap"
                   VerticalOptions="Center" />
            <Button x:Name="SignOutButton"
                    Text="Sign Out"
                    Clicked="OnSignClick"
                    Grid.Column="4"
                    HorizontalOptions="End"
                    VerticalOptions="Center" />
            <BoxView Grid.ColumnSpan="6"
                     Color="{StaticResource NeutralDarker}"
                     HeightRequest="1"
                     VerticalOptions="End" />
        </Grid>
    </Grid>
</ContentPage>