<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:local="clr-namespace:CSimple.Pages"
             xmlns:viewmodels="clr-namespace:CSimple.ViewModels"
             xmlns:models="clr-namespace:CSimple.Models"
             xmlns:behaviors="clr-namespace:CSimple.Behaviors"
             xmlns:converters="clr-namespace:CSimple.Converters"
             x:DataType="viewmodels:NetPageViewModel"
             x:Class="CSimple.Pages.NetPage"
             Title="Net">
    <ContentPage.Resources>
        <converters:NullToBoolConverter x:Key="NullToBoolConverter" />
        <converters:StringFormatConverter x:Key="StringFormatConverter" />
        <converters:BoolConverter x:Key="BoolConverter" />
        <converters:InverseBoolConverter x:Key="InverseBoolConverter" />
        <converters:BoolToTextConverter x:Key="BoolToTextConverter" />
        <converters:ModelDownloadButtonTextConverter x:Key="ModelDownloadButtonTextConverter" />
        <converters:ModelInputTypeDisplayConverter x:Key="ModelInputTypeDisplayConverter" />
        <converters:EnumToDisplayStringConverter x:Key="EnumToDisplayStringConverter" />
        <converters:EnumToIndexConverter x:Key="EnumToIndexConverter" />
        <converters:SafeImageSourceConverter x:Key="SafeImageSourceConverter" />
        <converters:BoolToColorConverter x:Key="BoolToColorConverter" />
        <converters:BoolToStringConverter x:Key="BoolToStringConverter" />
    </ContentPage.Resources>
    <ContentPage.Content>
        <ScrollView>
            <VerticalStackLayout Padding="{StaticResource PagePadding}"
                                 Spacing="{StaticResource SpacingLarge}">
                <Label Text="Neural Network Hub"
                       FontSize="{StaticResource FontSizeTitle}"
                       FontAttributes="Bold"
                       HorizontalOptions="Center" />
                <!-- Intelligent Pipeline Interaction Section -->
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource TertiaryDark}}"
                       CornerRadius="{StaticResource CornerRadiusLarge}"
                       Padding="{StaticResource CardPadding}">
                    <VerticalStackLayout Spacing="{StaticResource SpacingMedium}">
                        <Label Text="Intelligent Pipeline Interaction"
                               FontSize="{StaticResource FontSizeSubtitle}"
                               FontAttributes="Bold" />
                        <!-- Status Display Section -->
                        <Frame BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}"
                               CornerRadius="{StaticResource CornerRadiusSmall}"
                               Padding="{StaticResource CardContentPadding}"
                               Margin="0,0,0,16">
                            <VerticalStackLayout>
                                <Label Text="System Status"
                                       FontSize="{StaticResource FontSizeSmall}"
                                       FontAttributes="Bold" />
                                <Label Text="{Binding CurrentModelStatus}"
                                       TextColor="{AppThemeBinding Light={StaticResource PrimaryDark}, Dark={StaticResource Primary}}" />
                                <Label Text="Active Models:"
                                       FontSize="{StaticResource FontSizeSmall}" />
                                <Label Text="{Binding ActiveModelsCount, StringFormat='{0} models running'}"
                                       TextColor="{Binding ActiveModelsCount, Converter={StaticResource IntToColorConverter}, ConverterParameter=0|#C00|#4CAF50}" />
                            </VerticalStackLayout>
                        </Frame>
                        <!-- Pipeline Selector and Intelligence Toggle -->
                        <Grid ColumnDefinitions="*,Auto,Auto"
                              ColumnSpacing="{StaticResource SpacingMedium}">
                            <!-- Pipeline Selector -->
                            <VerticalStackLayout Grid.Column="0">
                                <Label Text="Select Pipeline:"
                                       FontSize="{StaticResource FontSizeSmall}"
                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                                <Picker x:Name="PipelineSelector"
                                        ItemsSource="{Binding AvailablePipelines}"
                                        SelectedItem="{Binding SelectedPipeline, Mode=TwoWay}"
                                        Title="Choose a pipeline..."
                                        FontSize="{StaticResource FontSizeBody}"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}"
                                        TextColor="{AppThemeBinding Light={StaticResource TextPrimary}, Dark={StaticResource TextPrimaryDark}}" />
                                <!-- Enhanced Pipeline Information -->
                                <Label Text="{Binding SelectedPipelineInfo}"
                                       FontSize="{StaticResource FontSizeCaption}"
                                       TextColor="{StaticResource TextSecondary}"
                                       IsVisible="{Binding SelectedPipeline, Converter={StaticResource NullToBoolConverter}}"
                                       Margin="0,4,0,0" />
                            </VerticalStackLayout>
                            <!-- Intelligence Toggle -->
                            <VerticalStackLayout Grid.Column="1"
                                                 VerticalOptions="Center">
                                <Label Text="Intelligence"
                                       FontSize="{StaticResource FontSizeSmall}"
                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                                       HorizontalOptions="Center" />
                                <Switch x:Name="IntelligenceToggle"
                                        IsToggled="{Binding IsIntelligenceActive, Mode=TwoWay}"
                                        OnColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource TertiaryDark}}"
                                        ThumbColor="{AppThemeBinding Light={StaticResource TextOnTertiary}, Dark={StaticResource TextOnTertiary}}"
                                        HorizontalOptions="Center" />
                            </VerticalStackLayout>
                            <!-- Status Indicator -->
                            <VerticalStackLayout Grid.Column="2"
                                                 VerticalOptions="Center">
                                <Frame BackgroundColor="{Binding IntelligenceStatusColor}"
                                       CornerRadius="15"
                                       Padding="8,4"
                                       HasShadow="False">
                                    <Label Text="{Binding IntelligenceStatusText}"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           TextColor="{AppThemeBinding Light={StaticResource TextOnPrimary}, Dark={StaticResource TextOnPrimary}}"
                                           FontAttributes="Bold" />
                                </Frame>
                            </VerticalStackLayout>
                        </Grid>
                        <!-- Pipeline Chat Section -->
                        <Label Text="Pipeline Chat"
                               FontAttributes="Bold" />
                        <Frame BackgroundColor="{StaticResource BackgroundSecondary}"
                               CornerRadius="{StaticResource CornerRadiusSmall}"
                               Padding="{StaticResource CardMargin}"
                               HeightRequest="300">
                            <ScrollView x:Name="PipelineChatScrollView"
                                        VerticalScrollBarVisibility="Always"
                                        HorizontalScrollBarVisibility="Never">
                                <CollectionView ItemsSource="{Binding PipelineChatMessages}"
                                                SelectionMode="None"
                                                x:Name="PipelineChatCollectionView">
                                    <CollectionView.ItemTemplate>
                                        <DataTemplate x:DataType="models:ChatMessage">
                                            <Grid Margin="{StaticResource MarginBottomTiny}">
                                                <!-- User Message (Right-aligned) -->
                                                <Frame IsVisible="{Binding IsFromUser, Converter={StaticResource BoolConverter}}"
                                                       BackgroundColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource TertiaryDark}}"
                                                       Padding="{StaticResource CardMargin}"
                                                       CornerRadius="8"
                                                       Margin="50,0,0,0"
                                                       HorizontalOptions="End">
                                                    <VerticalStackLayout>
                                                        <HorizontalStackLayout Spacing="{StaticResource SpacingSmall}">
                                                            <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                                                   FontSize="{StaticResource FontSizeSmall}"
                                                                   TextColor="{StaticResource TextOnTertiary}"
                                                                   Opacity="0.7"
                                                                   HorizontalOptions="Start" />
                                                            <Label Text="You"
                                                                   FontSize="{StaticResource FontSizeSmall}"
                                                                   FontAttributes="Bold"
                                                                   TextColor="{StaticResource TextOnTertiary}"
                                                                   HorizontalOptions="End" />
                                                        </HorizontalStackLayout>
                                                        <Label Text="{Binding Content}"
                                                               FontSize="{StaticResource FontSizeSmall}"
                                                               TextColor="{StaticResource TextOnTertiary}"
                                                               LineBreakMode="WordWrap" />
                                                    </VerticalStackLayout>
                                                </Frame>
                                                <!-- AI Response (Left-aligned) -->
                                                <Frame IsVisible="{Binding IsFromUser, Converter={StaticResource InverseBoolConverter}}"
                                                       BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundPrimary}, Dark={StaticResource Gray600}}"
                                                       Padding="{StaticResource CardMargin}"
                                                       CornerRadius="8"
                                                       Margin="0,0,5,0"
                                                       HorizontalOptions="Start"
                                                       BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray500}}">
                                                    <VerticalStackLayout>
                                                        <HorizontalStackLayout Spacing="{StaticResource SpacingSmall}">
                                                            <Label Text="{Binding Timestamp, StringFormat='{0:HH:mm}'}"
                                                                   FontSize="{StaticResource FontSizeSmall}"
                                                                   TextColor="{StaticResource TextPrimary}"
                                                                   HorizontalOptions="Start" />
                                                            <Label Text="Pipeline Assistant"
                                                                   FontSize="{StaticResource FontSizeSmall}"
                                                                   FontAttributes="Bold"
                                                                   TextColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource TertiaryDark}}"
                                                                   HorizontalOptions="Start" />
                                                        </HorizontalStackLayout>
                                                        <Label Text="{Binding Content}"
                                                               FontSize="{StaticResource FontSizeSmall}"
                                                               TextColor="{StaticResource TextPrimary}"
                                                               LineBreakMode="WordWrap" />
                                                    </VerticalStackLayout>
                                                </Frame>
                                            </Grid>
                                        </DataTemplate>
                                    </CollectionView.ItemTemplate>
                                    <CollectionView.EmptyView>
                                        <VerticalStackLayout HorizontalOptions="Center"
                                                             VerticalOptions="Center"
                                                             Spacing="{StaticResource SpacingSmall}">
                                            <Label Text="ðŸ”§"
                                                   FontSize="48"
                                                   HorizontalOptions="Center" />
                                            <Label Text="Select a pipeline and start chatting"
                                                   TextColor="{StaticResource TextSecondary}"
                                                   HorizontalOptions="Center"
                                                   FontSize="{StaticResource FontSizeSmall}" />
                                        </VerticalStackLayout>
                                    </CollectionView.EmptyView>
                                </CollectionView>
                            </ScrollView>
                        </Frame>
                        <!-- Input Section -->
                        <Label Text="Input"
                               FontAttributes="Bold" />
                        <!-- Text Input -->
                        <Grid ColumnDefinitions="*,Auto,Auto"
                              ColumnSpacing="{StaticResource SpacingSmall}">
                            <Entry Grid.Column="0"
                                   Placeholder="Enter your goal or question here..."
                                   Text="{Binding UserGoalInput, Mode=TwoWay}"
                                   x:Name="GoalTextInput"
                                   ReturnType="Send"
                                   ReturnCommand="{Binding SendGoalCommand}" />
                            <Button Grid.Column="1"
                                    Text="Send"
                                    Command="{Binding SendGoalCommand}"
                                    CommandParameter="{Binding Source={x:Reference GoalTextInput}, Path=Text}"
                                    BackgroundColor="Transparent"
                                    BorderColor="{StaticResource Primary}"
                                    BorderWidth="2"
                                    TextColor="{StaticResource Primary}"
                                    IsEnabled="{Binding CanSendGoal}" />
                            <Button Grid.Column="2"
                                    Text="Clear"
                                    Command="{Binding ClearPipelineChatCommand}"
                                    BackgroundColor="Transparent"
                                    BorderColor="{StaticResource Error}"
                                    BorderWidth="2"
                                    TextColor="{StaticResource Error}"
                                    FontSize="{StaticResource FontSizeSmall}" />
                        </Grid>
                        <!-- Media Input Options -->
                        <Label Text="Media Input (Optional)"
                               FontAttributes="Bold"
                               FontSize="{StaticResource FontSizeSmall}"
                               Margin="{StaticResource MarginTopSmall}" />
                        <Grid ColumnDefinitions="*,*"
                              RowDefinitions="Auto,Auto"
                              ColumnSpacing="{StaticResource SpacingSmall}"
                              RowSpacing="{StaticResource SpacingSmall}">
                            <!-- First row: Quick upload buttons -->
                            <HorizontalStackLayout Grid.Column="0"
                                                   Grid.ColumnSpan="2"
                                                   Spacing="{StaticResource SpacingSmall}">
                                <Button Text="Upload File"
                                        Command="{Binding SelectFileCommand}"
                                        BackgroundColor="Transparent"
                                        BorderColor="{StaticResource Primary}"
                                        BorderWidth="2"
                                        TextColor="{StaticResource Primary}"
                                        FontSize="{StaticResource FontSizeSmall}"
                                        WidthRequest="120" />
                                <Button Text="ðŸ“· Image"
                                        Command="{Binding SelectImageCommand}"
                                        BackgroundColor="Transparent"
                                        BorderColor="{StaticResource Secondary}"
                                        BorderWidth="2"
                                        TextColor="{StaticResource Secondary}"
                                        FontSize="{StaticResource FontSizeSmall}"
                                        WidthRequest="80"
                                        IsVisible="{Binding SupportsImageInput}" />
                                <Button Text="ðŸŽ¤ Audio"
                                        Command="{Binding SelectAudioCommand}"
                                        BackgroundColor="Transparent"
                                        BorderColor="{StaticResource Tertiary}"
                                        BorderWidth="2"
                                        TextColor="{StaticResource Tertiary}"
                                        FontSize="{StaticResource FontSizeSmall}"
                                        WidthRequest="80"
                                        IsVisible="{Binding SupportsAudioInput}" />
                                <Button Text="ðŸ—‘ï¸ Clear"
                                        Command="{Binding ClearMediaCommand}"
                                        BackgroundColor="Transparent"
                                        BorderColor="{StaticResource Error}"
                                        BorderWidth="2"
                                        TextColor="{StaticResource Error}"
                                        FontSize="{StaticResource FontSizeSmall}"
                                        WidthRequest="70"
                                        IsVisible="{Binding HasSelectedMedia}" />
                            </HorizontalStackLayout>
                            <!-- Second row: Drag and drop area -->
                            <Frame Grid.Row="1"
                                   Grid.ColumnSpan="2"
                                   BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}"
                                   BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray500}}"
                                   Padding="{StaticResource CardContentPadding}"
                                   CornerRadius="{StaticResource CornerRadiusSmall}"
                                   HeightRequest="60"
                                   x:Name="DropZoneFrame">
                                <Grid>
                                    <Label Text="ðŸ“ Drag and drop files here, or use the upload button above"
                                           FontSize="{StaticResource FontSizeSmall}"
                                           TextColor="{StaticResource TextSecondary}"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"
                                           IsVisible="{Binding HasSelectedMedia, Converter={StaticResource InverseBoolConverter}}" />
                                    <Label Text="ðŸŽ¯ Files ready for upload - click Send to proceed"
                                           FontSize="{StaticResource FontSizeSmall}"
                                           TextColor="{StaticResource Primary}"
                                           FontAttributes="Bold"
                                           HorizontalOptions="Center"
                                           VerticalOptions="Center"
                                           IsVisible="{Binding HasSelectedMedia}" />
                                    <!-- Gesture recognizer for tap-to-upload -->
                                    <Grid.GestureRecognizers>
                                        <TapGestureRecognizer Command="{Binding SelectFileCommand}" />
                                    </Grid.GestureRecognizers>
                                </Grid>
                            </Frame>
                        </Grid>
                        <!-- Selected Media Display -->
                        <Frame IsVisible="{Binding HasSelectedMedia}"
                               BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}"
                               CornerRadius="{StaticResource CornerRadiusSmall}"
                               Padding="{StaticResource CardContentPadding}"
                               Margin="{StaticResource MarginTopSmall}">
                            <VerticalStackLayout Spacing="{StaticResource SpacingSmall}">
                                <Label Text="Selected Media:"
                                       FontAttributes="Bold"
                                       FontSize="{StaticResource FontSizeSmall}" />
                                <!-- Selected Image -->
                                <Grid IsVisible="{Binding HasSelectedImage}"
                                      ColumnDefinitions="Auto,*,Auto">
                                    <Image Grid.Column="0"
                                           Source="{Binding SelectedImagePath, Converter={StaticResource SafeImageSourceConverter}}"
                                           WidthRequest="60"
                                           HeightRequest="60"
                                           Aspect="AspectFit" />
                                    <VerticalStackLayout Grid.Column="1"
                                                         VerticalOptions="Center"
                                                         Margin="{StaticResource MarginLeftMedium}">
                                        <Label Text="ðŸ“· Image attached"
                                               FontSize="{StaticResource FontSizeSmall}" />
                                        <Label Text="{Binding SelectedImageName}"
                                               FontSize="{StaticResource FontSizeCaption}"
                                               TextColor="{StaticResource TextSecondary}" />
                                    </VerticalStackLayout>
                                </Grid>
                                <!-- Selected Audio -->
                                <Grid IsVisible="{Binding HasSelectedAudio}"
                                      ColumnDefinitions="Auto,*">
                                    <Label Grid.Column="0"
                                           Text="ðŸŽ¤"
                                           FontSize="32"
                                           VerticalOptions="Center" />
                                    <VerticalStackLayout Grid.Column="1"
                                                         VerticalOptions="Center"
                                                         Margin="{StaticResource MarginLeftMedium}">
                                        <Label Text="Audio file attached"
                                               FontSize="{StaticResource FontSizeSmall}" />
                                        <Label Text="{Binding SelectedAudioName}"
                                               FontSize="{StaticResource FontSizeCaption}"
                                               TextColor="{StaticResource TextSecondary}" />
                                    </VerticalStackLayout>
                                </Grid>
                            </VerticalStackLayout>
                        </Frame>
                        <!-- Warning if no models active -->
                        <Frame BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}"
                               IsVisible="{Binding ActiveModelsCount, Converter={StaticResource IntToBoolConverter}, ConverterParameter=0}"
                               Padding="{StaticResource CardContentPadding}"
                               CornerRadius="{StaticResource CornerRadiusSmall}"
                               BorderColor="{AppThemeBinding Light={StaticResource Gray300}, Dark={StaticResource Gray500}}">
                            <VerticalStackLayout>
                                <Label Text="ðŸ’¡ Activate a model to start chatting"
                                       FontAttributes="Bold"
                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                                       HorizontalOptions="Center" />
                                <Label Text="Choose a model from the Model Management section above"
                                       TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                                       FontSize="{StaticResource FontSizeSmall}"
                                       HorizontalOptions="Center" />
                            </VerticalStackLayout>
                        </Frame>
                        <!-- Pipeline Status and Recording Options -->
                        <Grid ColumnDefinitions="*,*"
                              ColumnSpacing="{StaticResource SpacingMedium}">
                            <!-- Recording Settings -->
                            <Border Grid.Column="0"
                                    BackgroundColor="Transparent"
                                    Stroke="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                    StrokeThickness="2"
                                    StrokeShape="RoundRectangle 8"
                                    Padding="{StaticResource CardContentPadding}">
                                <VerticalStackLayout Spacing="{StaticResource SpacingTiny}">
                                    <Label Text="Recording Settings"
                                           FontSize="{StaticResource FontSizeSmall}"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                                    <Grid ColumnDefinitions="Auto,*"
                                          RowDefinitions="Auto,Auto"
                                          RowSpacing="4"
                                          ColumnSpacing="8">
                                        <CheckBox Grid.Row="0"
                                                  Grid.Column="0"
                                                  IsChecked="{Binding RecordMouseInputs, Mode=TwoWay}"
                                                  Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                                        <Label Grid.Row="0"
                                               Grid.Column="1"
                                               Text="Record Mouse Inputs"
                                               FontSize="{StaticResource FontSizeCaption}"
                                               VerticalOptions="Center" />
                                        <CheckBox Grid.Row="1"
                                                  Grid.Column="0"
                                                  IsChecked="{Binding RecordKeyboardInputs, Mode=TwoWay}"
                                                  Color="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                                        <Label Grid.Row="1"
                                               Grid.Column="1"
                                               Text="Record Keyboard Inputs"
                                               FontSize="{StaticResource FontSizeCaption}"
                                               VerticalOptions="Center" />
                                    </Grid>
                                </VerticalStackLayout>
                            </Border>
                            <!-- Pipeline Status -->
                            <Border Grid.Column="1"
                                    BackgroundColor="Transparent"
                                    Stroke="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SecondaryDark}}"
                                    StrokeThickness="2"
                                    StrokeShape="RoundRectangle 8"
                                    Padding="{StaticResource CardContentPadding}">
                                <VerticalStackLayout Spacing="{StaticResource SpacingTiny}">
                                    <Label Text="Pipeline Status"
                                           FontSize="{StaticResource FontSizeSmall}"
                                           FontAttributes="Bold"
                                           TextColor="{AppThemeBinding Light={StaticResource Secondary}, Dark={StaticResource SecondaryDark}}" />
                                    <Label Text="{Binding SelectedPipelineStatus}"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           TextColor="{Binding PipelineStatusColor}" />
                                    <Label Text="{Binding ActiveInputNodesCount, StringFormat='Active Input Nodes: {0}'}"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                                    <Label Text="{Binding ConnectedModelsCount, StringFormat='Connected Models: {0}'}"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}" />
                                </VerticalStackLayout>
                            </Border>
                        </Grid>
                    </VerticalStackLayout>
                </Frame>
                <!-- COMBINED COMPONENT: Model Management Center -->
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       CornerRadius="{StaticResource CornerRadiusLarge}"
                       Padding="{StaticResource CardPadding}">
                    <VerticalStackLayout Spacing="{StaticResource SpacingMedium}">
                        <Label Text="Model Management Center"
                               FontSize="{StaticResource FontSizeSubtitle}"
                               FontAttributes="Bold" />
                        <!-- Network Stats -->
                        <Grid ColumnDefinitions="*,*,*"
                              RowDefinitions="Auto,Auto">
                            <Border Grid.Column="0"
                                    BackgroundColor="Transparent"
                                    Stroke="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                    StrokeThickness="2"
                                    StrokeShape="RoundRectangle 8"
                                    Padding="{StaticResource CardContentPadding}"
                                    Margin="{StaticResource SpacingTiny}">
                                <VerticalStackLayout>
                                    <Label Text="Active Models"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                           FontAttributes="Bold" />
                                    <Label Text="{Binding ActiveModelsCount}"
                                           FontSize="{StaticResource FontSizeTitle}"
                                           HorizontalOptions="Center"
                                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Column="1"
                                    BackgroundColor="Transparent"
                                    Stroke="{AppThemeBinding Light={StaticResource Error}, Dark={StaticResource Error}}"
                                    StrokeThickness="2"
                                    StrokeShape="RoundRectangle 8"
                                    Padding="{StaticResource CardContentPadding}"
                                    Margin="{StaticResource SpacingTiny}">
                                <VerticalStackLayout>
                                    <Label Text="Available Models"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           TextColor="{AppThemeBinding Light={StaticResource Error}, Dark={StaticResource Error}}"
                                           FontAttributes="Bold" />
                                    <Label Text="{Binding AvailableModels.Count}"
                                           FontSize="{StaticResource FontSizeTitle}"
                                           HorizontalOptions="Center"
                                           TextColor="{AppThemeBinding Light={StaticResource Error}, Dark={StaticResource Error}}" />
                                </VerticalStackLayout>
                            </Border>
                            <Border Grid.Column="2"
                                    BackgroundColor="Transparent"
                                    Stroke="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource TertiaryDark}}"
                                    StrokeThickness="2"
                                    StrokeShape="RoundRectangle 8"
                                    Padding="{StaticResource CardContentPadding}"
                                    Margin="{StaticResource SpacingTiny}">
                                <VerticalStackLayout>
                                    <Label Text="Available Goals"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           TextColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource TertiaryDark}}"
                                           FontAttributes="Bold" />
                                    <Label Text="{Binding AvailableGoals.Count}"
                                           FontSize="{StaticResource FontSizeTitle}"
                                           HorizontalOptions="Center"
                                           TextColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource TertiaryDark}}" />
                                </VerticalStackLayout>
                            </Border>
                        </Grid>
                        <!-- Active Models List -->
                        <Label Text="Currently Active Models"
                               FontAttributes="Bold"
                               Margin="{StaticResource MarginTopMedium}" />
                        <CollectionView ItemsSource="{Binding ActiveModels}"
                                        EmptyView="No active models.">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:NeuralNetworkModel">
                                    <Grid Padding="{StaticResource SpacingTiny}"
                                          ColumnDefinitions="*,Auto">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label Text="{Binding Name}"
                                                   FontAttributes="Bold" />
                                            <Label Text="{Binding Description}"
                                                   FontSize="{StaticResource FontSizeSmall}" />
                                            <Label Text="{Binding Type}"
                                                   FontSize="{StaticResource FontSizeSmall}"
                                                   TextColor="{StaticResource TextSecondary}" />
                                        </VerticalStackLayout>
                                        <Button Grid.Column="1"
                                                Text="Stop"
                                                BackgroundColor="Transparent"
                                                BorderColor="{StaticResource Error}"
                                                BorderWidth="2"
                                                TextColor="{StaticResource Error}"
                                                Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.DeactivateModelCommand}"
                                                CommandParameter="{Binding .}"
                                                VerticalOptions="Center" />
                                    </Grid>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        <!-- Available Models Section -->
                        <Label Text="General Purpose Models"
                               FontAttributes="Bold"
                               IsVisible="{Binding IsGeneralModeActive}" />
                        <CollectionView ItemsSource="{Binding AvailableModels}"
                                        IsVisible="{Binding IsGeneralModeActive}"
                                        EmptyView="No general models available.">
                            <CollectionView.ItemsLayout>
                                <LinearItemsLayout Orientation="Vertical"
                                                   ItemSpacing="{StaticResource SpacingSmall}" />
                            </CollectionView.ItemsLayout>
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:NeuralNetworkModel">
                                    <Frame BorderColor="{Binding IsDownloaded, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#0078D4|#28A745}"
                                           Padding="{StaticResource CardContentPadding}"
                                           Margin="{StaticResource MarginTiny}"
                                           CornerRadius="{StaticResource CornerRadiusSmall}">
                                        <!-- Use Grid for better layout with the new dropdown -->
                                        <Grid ColumnDefinitions="*,Auto,Auto,Auto,Auto,Auto,Auto"
                                              ColumnSpacing="{StaticResource SpacingSmall}">
                                            <VerticalStackLayout Grid.Column="0">
                                                <Label Text="{Binding Name}"
                                                       FontAttributes="Bold" />
                                                <Label Text="{Binding Description}"
                                                       FontSize="{StaticResource FontSizeSmall}" />
                                                <!-- Enhanced status display with activation and download indicators -->
                                                <StackLayout Orientation="Horizontal"
                                                             Spacing="10">
                                                    <Label Text="{Binding TrainingStatus, StringFormat='Status: {0}'}"
                                                           FontSize="{StaticResource FontSizeCaption}"
                                                           TextColor="{StaticResource TextSecondary}" />
                                                    <!-- Activation Status Indicator -->
                                                    <Border BackgroundColor="{Binding IsActive, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#0078D4|#D3D3D3}"
                                                            WidthRequest="10"
                                                            HeightRequest="10"
                                                            StrokeShape="RoundRectangle 5"
                                                            ToolTipProperties.Text="{Binding IsActive, StringFormat='Active: {0}'}" />
                                                    <!-- Status Text Labels -->
                                                    <Label Text="{Binding IsActive, StringFormat='Active: {0}'}"
                                                           FontSize="{StaticResource FontSizeCaption}"
                                                           TextColor="{Binding IsActive, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#0078D4|#808080}" />
                                                    <!-- Download Status Indicator -->
                                                    <Border BackgroundColor="{Binding IsDownloaded, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#28A745|#D3D3D3}"
                                                            WidthRequest="10"
                                                            HeightRequest="10"
                                                            StrokeShape="RoundRectangle 5"
                                                            ToolTipProperties.Text="{Binding IsDownloaded, StringFormat='Downloaded: {0}'}" />
                                                    <Label Text="{Binding IsDownloaded, StringFormat='Downloaded: {0}'}"
                                                           FontSize="{StaticResource FontSizeCaption}"
                                                           TextColor="{Binding IsDownloaded, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#28A745|#808080}" />
                                                </StackLayout>
                                            </VerticalStackLayout>
                                            <!-- Input Type Dropdown -->
                                            <VerticalStackLayout Grid.Column="1"
                                                                 VerticalOptions="Center">
                                                <Label Text="Input Type:"
                                                       FontSize="{StaticResource FontSizeCaption}"
                                                       TextColor="{StaticResource TextSecondary}"
                                                       Margin="{StaticResource MarginBottomTiny}"
                                                       HorizontalOptions="Center" />
                                                <Picker SelectedIndex="{Binding InputType, Mode=TwoWay, Converter={StaticResource EnumToIndexConverter}}"
                                                        ItemsSource="{x:Static models:NeuralNetworkModel.InputTypeDisplayItems}"
                                                        ItemDisplayBinding="{Binding DisplayName}"
                                                        SelectedIndexChanged="OnModelInputTypeChanged"
                                                        WidthRequest="120"
                                                        x:Name="InputTypePicker" />
                                            </VerticalStackLayout>
                                            <!-- HuggingFace Model Download/Delete Button with Progress -->
                                            <Grid Grid.Column="2"
                                                  VerticalOptions="Center"
                                                  WidthRequest="180">
                                                <Button Text="{Binding DownloadButtonText}"
                                                        Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:NetPageViewModel}}, Path=DownloadOrDeleteModelCommand}"
                                                        CommandParameter="{Binding .}"
                                                        BackgroundColor="Transparent"
                                                        BorderColor="{StaticResource Primary}"
                                                        BorderWidth="2"
                                                        TextColor="{StaticResource Primary}"
                                                        IsVisible="{Binding IsHuggingFaceReference}"
                                                        WidthRequest="180"
                                                        HeightRequest="40" />
                                                <!-- Progress bar overlay - positioned below button -->
                                                <Frame IsVisible="{Binding IsDownloading}"
                                                       BackgroundColor="Transparent"
                                                       BorderColor="Transparent"
                                                       Padding="0"
                                                       VerticalOptions="End"
                                                       HorizontalOptions="Fill"
                                                       HeightRequest="4"
                                                       Margin="0,44,0,0">
                                                    <ProgressBar Progress="{Binding DownloadProgress}"
                                                                 ProgressColor="{StaticResource Primary}"
                                                                 BackgroundColor="{AppThemeBinding Light={StaticResource NeutralLight}, Dark={StaticResource NeutralDark}}"
                                                                 HeightRequest="4" />
                                                </Frame>
                                                <!-- Download status label - positioned below progress bar -->
                                                <Label Text="{Binding DownloadStatus}"
                                                       IsVisible="{Binding IsDownloading}"
                                                       FontSize="10"
                                                       TextColor="{StaticResource TextSecondary}"
                                                       HorizontalOptions="Center"
                                                       VerticalOptions="End"
                                                       BackgroundColor="Transparent"
                                                       Margin="0,50,0,0" />
                                            </Grid>
                                            <!-- Delete HF Reference Button -->
                                            <Button Grid.Column="3"
                                                    Text="Delete Ref"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:NetPageViewModel}}, Path=DeleteModelReferenceCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="Transparent"
                                                    BorderColor="{StaticResource Error}"
                                                    BorderWidth="2"
                                                    TextColor="{StaticResource Error}"
                                                    VerticalOptions="Center"
                                                    IsVisible="{Binding IsHuggingFaceReference}" />
                                            <!-- Train/Refine Button -->
                                            <Button Grid.Column="4"
                                                    Text="Train"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:NetPageViewModel}}, Path=GoToOrientCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="Transparent"
                                                    BorderColor="{StaticResource Primary}"
                                                    BorderWidth="2"
                                                    TextColor="{StaticResource Primary}"
                                                    VerticalOptions="Center" />
                                            <!-- Activate/Deactivate Button with dynamic text and color -->
                                            <Button Grid.Column="5"
                                                    Text="{Binding IsActive, Converter={StaticResource BoolToStringConverter}, ConverterParameter='Deactivate|Activate'}"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:NetPageViewModel}}, Path=ToggleModelActivationCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="Transparent"
                                                    BorderColor="{StaticResource Primary}"
                                                    BorderWidth="2"
                                                    TextColor="{StaticResource Primary}"
                                                    VerticalOptions="Center" />
                                            <!-- Open in File Explorer Button -->
                                            <Button Grid.Column="6"
                                                    Text="File Explorer"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type viewmodels:NetPageViewModel}}, Path=OpenModelInExplorerCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="Transparent"
                                                    BorderColor="{StaticResource Primary}"
                                                    BorderWidth="2"
                                                    TextColor="{StaticResource Primary}"
                                                    VerticalOptions="Center"
                                                    ToolTipProperties.Text="Open in File Explorer" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        <!-- Specific Goal Section -->
                        <Label Text="Available Goal Models"
                               FontAttributes="Bold"
                               IsVisible="{Binding IsSpecificModeActive}" />
                        <CollectionView ItemsSource="{Binding AvailableGoals}"
                                        IsVisible="{Binding IsSpecificModeActive}"
                                        EmptyView="No goals available.">
                            <CollectionView.ItemTemplate>
                                <DataTemplate x:DataType="models:SpecificGoal">
                                    <Frame BorderColor="{AppThemeBinding Light={StaticResource MidGray}, Dark={StaticResource Background_Mid}}"
                                           Padding="{StaticResource CardContentPadding}"
                                           Margin="{StaticResource MarginTiny}"
                                           CornerRadius="{StaticResource CornerRadiusSmall}">
                                        <Grid ColumnDefinitions="*,Auto">
                                            <VerticalStackLayout Grid.Column="0">
                                                <Label Text="{Binding Name}"
                                                       FontAttributes="Bold" />
                                                <Label Text="{Binding Description}"
                                                       FontSize="{StaticResource FontSizeSmall}" />
                                            </VerticalStackLayout>
                                            <Button Grid.Column="1"
                                                    Text="Load Goal"
                                                    Command="{Binding Source={RelativeSource AncestorType={x:Type ContentPage}}, Path=BindingContext.LoadSpecificGoalCommand}"
                                                    CommandParameter="{Binding .}"
                                                    BackgroundColor="Transparent"
                                                    BorderColor="{StaticResource Secondary}"
                                                    BorderWidth="2"
                                                    TextColor="{StaticResource Secondary}" />
                                        </Grid>
                                    </Frame>
                                </DataTemplate>
                            </CollectionView.ItemTemplate>
                        </CollectionView>
                        <!-- Model Sharing Controls -->
                        <Label Text="Model Sharing"
                               FontAttributes="Bold"
                               Margin="{StaticResource MarginTopMedium}" />
                        <Grid ColumnDefinitions="*,*"
                              ColumnSpacing="{StaticResource SpacingSmall}">
                            <Button Grid.Column="0"
                                    Text="Share Local Model"
                                    Command="{Binding ShareModelCommand}"
                                    BackgroundColor="Transparent"
                                    BorderColor="{StaticResource Primary}"
                                    BorderWidth="2"
                                    TextColor="{StaticResource Primary}" />
                            <Button Grid.Column="1"
                                    Text="Import Local Model"
                                    Clicked="OnImportModelClicked"
                                    IsEnabled="{Binding IsLoading, Converter={StaticResource InverseBoolConverter}}"
                                    BackgroundColor="Transparent"
                                    BorderColor="{StaticResource Primary}"
                                    BorderWidth="2"
                                    TextColor="{StaticResource Primary}" />
                        </Grid>
                        <ActivityIndicator IsRunning="{Binding IsLoading}"
                                           IsVisible="{Binding IsLoading}"
                                           HorizontalOptions="Center"
                                           Margin="{StaticResource MarginTopSmall}" />
                        <Label Text="HuggingFace Model Import"
                               FontAttributes="Bold"
                               Margin="{StaticResource MarginTopMedium}" />
                        <Grid ColumnDefinitions="*,Auto"
                              ColumnSpacing="{StaticResource SpacingSmall}">
                            <Entry Grid.Column="0"
                                   Placeholder="Search HuggingFace models..."
                                   Text="{Binding HuggingFaceSearchQuery}" />
                            <Button Grid.Column="1"
                                    Text="Search"
                                    Clicked="OnHuggingFaceSearchClicked"
                                    BackgroundColor="Transparent"
                                    BorderColor="{StaticResource Secondary}"
                                    BorderWidth="2"
                                    TextColor="{StaticResource Secondary}" />
                        </Grid>
                    </VerticalStackLayout>
                </Frame>
                <!-- Model Training/Alignment Section -->
                <Frame BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                       CornerRadius="{StaticResource CornerRadiusLarge}"
                       Padding="{StaticResource CardPadding}">
                    <VerticalStackLayout Spacing="{StaticResource SpacingMedium}">
                        <Label Text="Model Training &amp; Alignment"
                               FontSize="{StaticResource FontSizeSubtitle}"
                               FontAttributes="Bold"
                               TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                        <!-- Training Mode Selection -->
                        <VerticalStackLayout Spacing="{StaticResource SpacingSmall}">
                            <Label Text="Select Training Mode"
                                   FontAttributes="Bold"
                                   FontSize="{StaticResource FontSizeSmall}" />
                            <Picker ItemsSource="{Binding TrainingModes}"
                                    SelectedItem="{Binding SelectedTrainingMode}"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}" />
                        </VerticalStackLayout>
                        <!-- Pretrained Model Selection (Only for Alignment Mode) -->
                        <VerticalStackLayout Spacing="{StaticResource SpacingSmall}"
                                             IsVisible="{Binding IsPretrainedModelMode}">
                            <Label Text="Select Pretrained Model (All Types Supported)"
                                   FontAttributes="Bold"
                                   FontSize="{StaticResource FontSizeSmall}" />
                            <Grid ColumnDefinitions="*,Auto"
                                  ColumnSpacing="{StaticResource SpacingSmall}">
                                <Label Grid.Column="0"
                                       Text="{Binding TrainingModelName}"
                                       VerticalOptions="Center"
                                       Padding="8"
                                       BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}"
                                       TextColor="{StaticResource TextSecondary}" />
                                <Button Grid.Column="1"
                                        Text="Select Model"
                                        Command="{Binding SelectTrainingModelCommand}"
                                        BackgroundColor="Transparent"
                                        BorderColor="{StaticResource Secondary}"
                                        BorderWidth="2"
                                        TextColor="{StaticResource Secondary}"
                                        WidthRequest="120" />
                            </Grid>
                        </VerticalStackLayout>
                        <!-- Model Architecture Selection (Only for Training from Scratch) -->
                        <VerticalStackLayout Spacing="{StaticResource SpacingSmall}"
                                             IsVisible="{Binding IsTrainingFromScratchMode}">
                            <Label Text="Select Model Architecture"
                                   FontAttributes="Bold"
                                   FontSize="{StaticResource FontSizeSmall}" />
                            <Grid ColumnDefinitions="*,Auto"
                                  ColumnSpacing="{StaticResource SpacingSmall}">
                                <Picker Grid.Column="0"
                                        ItemsSource="{Binding ModelArchitectures}"
                                        SelectedItem="{Binding SelectedModelArchitecture}"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}" />
                                <Button Grid.Column="1"
                                        Text="Configure"
                                        Command="{Binding SelectModelArchitectureCommand}"
                                        BackgroundColor="Transparent"
                                        BorderColor="{StaticResource Tertiary}"
                                        BorderWidth="2"
                                        TextColor="{StaticResource Tertiary}"
                                        WidthRequest="100" />
                            </Grid>
                        </VerticalStackLayout>
                        <!-- Alignment Technique Selection (Only for Pretrained Models) -->
                        <VerticalStackLayout Spacing="{StaticResource SpacingSmall}"
                                             IsVisible="{Binding IsPretrainedModelMode}">
                            <Label Text="Choose Alignment Technique"
                                   FontAttributes="Bold"
                                   FontSize="{StaticResource FontSizeSmall}" />
                            <Picker ItemsSource="{Binding AlignmentTechniques}"
                                    SelectedItem="{Binding SelectedAlignmentTechnique}"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}" />
                        </VerticalStackLayout>
                        <!-- Fine-Tuning Method (Only for some alignment techniques) -->
                        <VerticalStackLayout Spacing="{StaticResource SpacingSmall}"
                                             IsVisible="{Binding IsPretrainedModelMode}">
                            <Label Text="Choose Fine-Tuning Method"
                                   FontAttributes="Bold"
                                   FontSize="{StaticResource FontSizeSmall}" />
                            <Picker ItemsSource="{Binding FineTuningMethods}"
                                    SelectedItem="{Binding SelectedFineTuningMethod}"
                                    BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}" />
                        </VerticalStackLayout>
                        <!-- Dataset Configuration -->
                        <VerticalStackLayout Spacing="{StaticResource SpacingMedium}">
                            <Label Text="Configure Training Data"
                                   FontAttributes="Bold"
                                   FontSize="{StaticResource FontSizeSmall}" />
                            <!-- Dataset Source Selection -->
                            <Frame BorderColor="{AppThemeBinding Light={StaticResource Tertiary}, Dark={StaticResource TertiaryDark}}"
                                   CornerRadius="{StaticResource CornerRadiusSmall}"
                                   Padding="{StaticResource CardContentPadding}">
                                <VerticalStackLayout Spacing="{StaticResource SpacingSmall}">
                                    <Label Text="Data Source"
                                           FontAttributes="Bold"
                                           FontSize="{StaticResource FontSizeCaption}" />
                                    <Grid ColumnDefinitions="*,*"
                                          ColumnSpacing="{StaticResource SpacingSmall}">
                                        <RadioButton Grid.Column="0"
                                                     Content="Use Recorded Actions"
                                                     IsChecked="{Binding UseRecordedActionsForTraining}"
                                                     FontSize="{StaticResource FontSizeSmall}" />
                                        <RadioButton Grid.Column="1"
                                                     Content="Use Custom Dataset"
                                                     IsChecked="{Binding UseRecordedActionsForTraining, Converter={StaticResource InverseBoolConverter}}"
                                                     FontSize="{StaticResource FontSizeSmall}" />
                                    </Grid>
                                </VerticalStackLayout>
                            </Frame>
                            <!-- Recorded Actions Configuration -->
                            <Frame IsVisible="{Binding UseRecordedActionsForTraining}"
                                   BorderColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}"
                                   CornerRadius="{StaticResource CornerRadiusSmall}"
                                   Padding="{StaticResource CardContentPadding}">
                                <VerticalStackLayout Spacing="{StaticResource SpacingSmall}">
                                    <Label Text="Recorded Actions Training Setup"
                                           FontAttributes="Bold"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           TextColor="{AppThemeBinding Light={StaticResource Primary}, Dark={StaticResource PrimaryDark}}" />
                                    <!-- Action Session Selection -->
                                    <Grid ColumnDefinitions="*,Auto"
                                          ColumnSpacing="{StaticResource SpacingSmall}">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label Text="Select Action Session"
                                                   FontSize="{StaticResource FontSizeCaption}"
                                                   TextColor="{StaticResource TextSecondary}" />
                                            <Picker ItemsSource="{Binding AvailableActionSessions}"
                                                    SelectedItem="{Binding SelectedActionSession}"
                                                    ItemDisplayBinding="{Binding ActionName}"
                                                    BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}" />
                                        </VerticalStackLayout>
                                        <Button Grid.Column="1"
                                                Text="Refresh"
                                                Command="{Binding RefreshActionSessionsCommand}"
                                                BackgroundColor="Transparent"
                                                BorderColor="{StaticResource Secondary}"
                                                BorderWidth="2"
                                                TextColor="{StaticResource Secondary}"
                                                FontSize="{StaticResource FontSizeSmall}"
                                                WidthRequest="80"
                                                VerticalOptions="End" />
                                    </Grid>
                                    <!-- Input Selection -->
                                    <Label Text="Select Input Sources (What the model should learn from)"
                                           FontAttributes="Bold"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           Margin="0,10,0,0" />
                                    <Grid ColumnDefinitions="*,*"
                                          RowDefinitions="Auto,Auto"
                                          ColumnSpacing="{StaticResource SpacingSmall}"
                                          RowSpacing="{StaticResource SpacingTiny}">
                                        <CheckBox Grid.Column="0"
                                                  Grid.Row="0"
                                                  IsChecked="{Binding IncludeScreenImages}"
                                                  Color="{StaticResource Primary}" />
                                        <Label Grid.Column="0"
                                               Grid.Row="0"
                                               Text="Screen Images"
                                               FontSize="{StaticResource FontSizeCaption}"
                                               VerticalOptions="Center"
                                               Margin="30,0,0,0" />
                                        <CheckBox Grid.Column="1"
                                                  Grid.Row="0"
                                                  IsChecked="{Binding IncludeWebcamImages}"
                                                  Color="{StaticResource Primary}" />
                                        <Label Grid.Column="1"
                                               Grid.Row="0"
                                               Text="Webcam Images"
                                               FontSize="{StaticResource FontSizeCaption}"
                                               VerticalOptions="Center"
                                               Margin="30,0,0,0" />
                                        <CheckBox Grid.Column="0"
                                                  Grid.Row="1"
                                                  IsChecked="{Binding IncludePcAudio}"
                                                  Color="{StaticResource Primary}" />
                                        <Label Grid.Column="0"
                                               Grid.Row="1"
                                               Text="PC Audio"
                                               FontSize="{StaticResource FontSizeCaption}"
                                               VerticalOptions="Center"
                                               Margin="30,0,0,0" />
                                        <CheckBox Grid.Column="1"
                                                  Grid.Row="1"
                                                  IsChecked="{Binding IncludeWebcamAudio}"
                                                  Color="{StaticResource Primary}" />
                                        <Label Grid.Column="1"
                                               Grid.Row="1"
                                               Text="Webcam Audio"
                                               FontSize="{StaticResource FontSizeCaption}"
                                               VerticalOptions="Center"
                                               Margin="30,0,0,0" />
                                    </Grid>
                                    <!-- Output Target -->
                                    <Label Text="Output Target (What the model should predict)"
                                           FontAttributes="Bold"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           Margin="0,10,0,0" />
                                    <Label Text="Mouse and Keyboard Actions"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           TextColor="{StaticResource TextSecondary}"
                                           Padding="10,5"
                                           BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}" />
                                    <!-- Dataset Split Configuration -->
                                    <Label Text="Dataset Split Configuration"
                                           FontAttributes="Bold"
                                           FontSize="{StaticResource FontSizeCaption}"
                                           Margin="0,10,0,0" />
                                    <Grid ColumnDefinitions="*,*,*"
                                          ColumnSpacing="{StaticResource SpacingSmall}">
                                        <VerticalStackLayout Grid.Column="0">
                                            <Label Text="Training %"
                                                   FontSize="{StaticResource FontSizeCaption}"
                                                   HorizontalOptions="Center" />
                                            <Entry Text="{Binding TrainingDataPercentage}"
                                                   Keyboard="Numeric"
                                                   FontSize="{StaticResource FontSizeSmall}"
                                                   HorizontalTextAlignment="Center" />
                                        </VerticalStackLayout>
                                        <VerticalStackLayout Grid.Column="1">
                                            <Label Text="Validation %"
                                                   FontSize="{StaticResource FontSizeCaption}"
                                                   HorizontalOptions="Center" />
                                            <Entry Text="{Binding ValidationDataPercentage}"
                                                   Keyboard="Numeric"
                                                   FontSize="{StaticResource FontSizeSmall}"
                                                   HorizontalTextAlignment="Center" />
                                        </VerticalStackLayout>
                                        <VerticalStackLayout Grid.Column="2">
                                            <Label Text="Test %"
                                                   FontSize="{StaticResource FontSizeCaption}"
                                                   HorizontalOptions="Center" />
                                            <Entry Text="{Binding TestDataPercentage}"
                                                   Keyboard="Numeric"
                                                   FontSize="{StaticResource FontSizeSmall}"
                                                   HorizontalTextAlignment="Center" />
                                        </VerticalStackLayout>
                                    </Grid>
                                    <Button Text="Process Recorded Actions"
                                            Command="{Binding ProcessRecordedActionsCommand}"
                                            BackgroundColor="Transparent"
                                            BorderColor="{StaticResource Primary}"
                                            BorderWidth="2"
                                            TextColor="{StaticResource Primary}"
                                            Margin="0,10,0,0" />
                                </VerticalStackLayout>
                            </Frame>
                            <!-- Custom Dataset Configuration -->
                            <VerticalStackLayout IsVisible="{Binding UseRecordedActionsForTraining, Converter={StaticResource InverseBoolConverter}}"
                                                 Spacing="{StaticResource SpacingSmall}">
                                <!-- Dataset Format Selection -->
                                <Grid ColumnDefinitions="*,Auto"
                                      ColumnSpacing="{StaticResource SpacingSmall}">
                                    <Picker Grid.Column="0"
                                            ItemsSource="{Binding DatasetFormats}"
                                            SelectedItem="{Binding SelectedDatasetFormat}"
                                            BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}" />
                                    <Button Grid.Column="1"
                                            Text="Validate"
                                            Command="{Binding ValidateDatasetCommand}"
                                            BackgroundColor="Transparent"
                                            BorderColor="{StaticResource Warning}"
                                            BorderWidth="2"
                                            TextColor="{StaticResource Warning}"
                                            FontSize="{StaticResource FontSizeSmall}"
                                            WidthRequest="80" />
                                </Grid>
                                <!-- Training Dataset (Required) -->
                                <Grid ColumnDefinitions="*,Auto,Auto"
                                      ColumnSpacing="{StaticResource SpacingSmall}">
                                    <VerticalStackLayout Grid.Column="0"
                                                         VerticalOptions="Center">
                                        <Label Text="{Binding TrainingDatasetPath, TargetNullValue='No training dataset selected'}"
                                               FontSize="{StaticResource FontSizeSmall}"
                                               LineBreakMode="TailTruncation" />
                                        <Label Text="Training dataset (required)"
                                               FontSize="{StaticResource FontSizeCaption}"
                                               TextColor="{StaticResource TextSecondary}" />
                                    </VerticalStackLayout>
                                    <Button Grid.Column="1"
                                            Text="Select Training Dataset"
                                            Command="{Binding SelectTrainingDatasetCommand}"
                                            BackgroundColor="Transparent"
                                            BorderColor="{StaticResource Primary}"
                                            BorderWidth="2"
                                            TextColor="{StaticResource Primary}"
                                            FontSize="{StaticResource FontSizeSmall}"
                                            WidthRequest="160" />
                                    <Button Grid.Column="2"
                                            Text="Create New"
                                            Command="{Binding CreateDatasetCommand}"
                                            BackgroundColor="Transparent"
                                            BorderColor="{StaticResource Tertiary}"
                                            BorderWidth="2"
                                            TextColor="{StaticResource Tertiary}"
                                            FontSize="{StaticResource FontSizeSmall}"
                                            WidthRequest="100" />
                                </Grid>
                                <!-- Validation Dataset (Optional) -->
                                <Grid ColumnDefinitions="*,Auto"
                                      ColumnSpacing="{StaticResource SpacingSmall}">
                                    <VerticalStackLayout Grid.Column="0"
                                                         VerticalOptions="Center">
                                        <Label Text="{Binding ValidationDatasetPath, TargetNullValue='No validation dataset selected'}"
                                               FontSize="{StaticResource FontSizeSmall}"
                                               LineBreakMode="TailTruncation" />
                                        <Label Text="Validation dataset (optional)"
                                               FontSize="{StaticResource FontSizeCaption}"
                                               TextColor="{StaticResource TextSecondary}" />
                                    </VerticalStackLayout>
                                    <Button Grid.Column="1"
                                            Text="Select Validation Dataset"
                                            Command="{Binding SelectValidationDatasetCommand}"
                                            BackgroundColor="Transparent"
                                            BorderColor="{StaticResource Secondary}"
                                            BorderWidth="2"
                                            TextColor="{StaticResource Secondary}"
                                            FontSize="{StaticResource FontSizeSmall}"
                                            WidthRequest="180" />
                                </Grid>
                                <!-- Test Dataset (Optional) -->
                                <Grid ColumnDefinitions="*,Auto"
                                      ColumnSpacing="{StaticResource SpacingSmall}">
                                    <VerticalStackLayout Grid.Column="0"
                                                         VerticalOptions="Center">
                                        <Label Text="{Binding TestDatasetPath, TargetNullValue='No test dataset selected'}"
                                               FontSize="{StaticResource FontSizeSmall}"
                                               LineBreakMode="TailTruncation" />
                                        <Label Text="Test dataset (optional)"
                                               FontSize="{StaticResource FontSizeCaption}"
                                               TextColor="{StaticResource TextSecondary}" />
                                    </VerticalStackLayout>
                                    <Button Grid.Column="1"
                                            Text="Select Test Dataset"
                                            Command="{Binding SelectTestDatasetCommand}"
                                            BackgroundColor="Transparent"
                                            BorderColor="{StaticResource Secondary}"
                                            BorderWidth="2"
                                            TextColor="{StaticResource Secondary}"
                                            FontSize="{StaticResource FontSizeSmall}"
                                            WidthRequest="160" />
                                </Grid>
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                        <!-- Hyperparameters -->
                        <VerticalStackLayout Spacing="{StaticResource SpacingSmall}">
                            <Label Text="Set Hyperparameters"
                                   FontAttributes="Bold"
                                   FontSize="{StaticResource FontSizeSmall}" />
                            <Grid ColumnDefinitions="*,*,*"
                                  ColumnSpacing="{StaticResource SpacingMedium}">
                                <VerticalStackLayout Grid.Column="0">
                                    <Label Text="Learning Rate"
                                           FontSize="{StaticResource FontSizeCaption}" />
                                    <Entry Text="{Binding LearningRate}"
                                           Keyboard="Numeric"
                                           FontSize="{StaticResource FontSizeSmall}" />
                                </VerticalStackLayout>
                                <VerticalStackLayout Grid.Column="1">
                                    <Label Text="Epochs"
                                           FontSize="{StaticResource FontSizeCaption}" />
                                    <Entry Text="{Binding Epochs}"
                                           Keyboard="Numeric"
                                           FontSize="{StaticResource FontSizeSmall}" />
                                </VerticalStackLayout>
                                <VerticalStackLayout Grid.Column="2">
                                    <Label Text="Batch Size"
                                           FontSize="{StaticResource FontSizeCaption}" />
                                    <Entry Text="{Binding BatchSize}"
                                           Keyboard="Numeric"
                                           FontSize="{StaticResource FontSizeSmall}" />
                                </VerticalStackLayout>
                            </Grid>
                            <!-- Advanced Configuration Toggle -->
                            <Grid ColumnDefinitions="*,Auto"
                                  ColumnSpacing="{StaticResource SpacingSmall}"
                                  Margin="0,10,0,0">
                                <Label Grid.Column="0"
                                       Text="Advanced Configuration"
                                       VerticalOptions="Center"
                                       FontSize="{StaticResource FontSizeSmall}" />
                                <Switch Grid.Column="1"
                                        IsToggled="{Binding UseAdvancedConfig}"
                                        OnColor="{StaticResource Primary}" />
                            </Grid>
                            <!-- Advanced Configuration Section -->
                            <VerticalStackLayout IsVisible="{Binding UseAdvancedConfig}"
                                                 Spacing="{StaticResource SpacingSmall}">
                                <Label Text="Custom Hyperparameters (JSON format)"
                                       FontSize="{StaticResource FontSizeCaption}"
                                       TextColor="{StaticResource TextSecondary}" />
                                <Editor Text="{Binding CustomHyperparameters}"
                                        Placeholder="Enter custom hyperparameters in JSON format..."
                                        HeightRequest="80"
                                        BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}"
                                        FontSize="{StaticResource FontSizeSmall}" />
                            </VerticalStackLayout>
                        </VerticalStackLayout>
                        <!-- Model Naming and Training Execution -->
                        <VerticalStackLayout Spacing="{StaticResource SpacingSmall}">
                            <Label Text="{Binding IsTrainingFromScratchMode, Converter={StaticResource BoolToTextConverter}, ConverterParameter=Name Your New Model|Name Your Aligned Model}"
                                   FontAttributes="Bold"
                                   FontSize="{StaticResource FontSizeSmall}" />
                            <Grid ColumnDefinitions="*,Auto"
                                  ColumnSpacing="{StaticResource SpacingSmall}">
                                <Entry Grid.Column="0"
                                       Text="{Binding NewModelName}"
                                       Placeholder="{Binding IsTrainingFromScratchMode, Converter={StaticResource BoolToTextConverter}, ConverterParameter=Enter name for the new model...|Enter name for the aligned model...}"
                                       BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}" />
                                <Button Grid.Column="1"
                                        Text="{Binding IsTraining, Converter={StaticResource BoolToTextConverter}, ConverterParameter=Stop Training|Start Training}"
                                        Command="{Binding ToggleTrainingCommand}"
                                        IsEnabled="{Binding CanToggleTraining}"
                                        BackgroundColor="Transparent"
                                        BorderColor="{Binding IsTraining, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#C00|#4CAF50}"
                                        BorderWidth="2"
                                        TextColor="{Binding IsTraining, Converter={StaticResource BoolToColorConverter}, ConverterParameter=#C00|#4CAF50}"
                                        WidthRequest="120" />
                            </Grid>
                        </VerticalStackLayout>
                        <!-- Training Progress Display -->
                        <VerticalStackLayout Spacing="{StaticResource SpacingSmall}"
                                             IsVisible="{Binding IsTraining}">
                            <Label Text="Training Progress"
                                   FontAttributes="Bold"
                                   FontSize="{StaticResource FontSizeSmall}" />
                            <ProgressBar Progress="{Binding TrainingProgress}"
                                         ProgressColor="{StaticResource Primary}" />
                            <Label Text="{Binding TrainingStatus}"
                                   FontSize="{StaticResource FontSizeCaption}"
                                   HorizontalTextAlignment="Center" />
                            <Grid ColumnDefinitions="*,*"
                                  ColumnSpacing="{StaticResource SpacingSmall}">
                                <Label Grid.Column="0"
                                       Text="{Binding TrainingElapsed, StringFormat='Elapsed: {0}'}"
                                       FontSize="{StaticResource FontSizeCaption}" />
                                <Label Grid.Column="1"
                                       Text="{Binding TrainingEta, StringFormat='ETA: {0}'}"
                                       FontSize="{StaticResource FontSizeCaption}"
                                       HorizontalTextAlignment="End" />
                            </Grid>
                        </VerticalStackLayout>
                        <!-- Training Progress -->
                        <Frame IsVisible="{Binding IsTraining}"
                               BackgroundColor="{AppThemeBinding Light={StaticResource BackgroundSecondary}, Dark={StaticResource BackgroundDark}}"
                               CornerRadius="{StaticResource CornerRadiusSmall}"
                               Padding="{StaticResource CardContentPadding}">
                            <VerticalStackLayout Spacing="{StaticResource SpacingSmall}">
                                <Label Text="{Binding IsTrainingFromScratchMode, Converter={StaticResource BoolToTextConverter}, ConverterParameter=Training Progress (From Scratch)|Training Progress (Alignment)}"
                                       FontAttributes="Bold"
                                       FontSize="{StaticResource FontSizeSmall}" />
                                <ProgressBar Progress="{Binding TrainingProgress}"
                                             ProgressColor="{StaticResource Primary}"
                                             BackgroundColor="{AppThemeBinding Light={StaticResource NeutralLight}, Dark={StaticResource NeutralDark}}" />
                                <Label Text="{Binding TrainingStatusDisplay}"
                                       FontSize="{StaticResource FontSizeCaption}"
                                       HorizontalOptions="Center" />
                            </VerticalStackLayout>
                        </Frame>
                        <!-- Training Status -->
                        <Label Text="{Binding TrainingStatus}"
                               FontSize="{StaticResource FontSizeSmall}"
                               TextColor="{AppThemeBinding Light={StaticResource TextSecondary}, Dark={StaticResource TextSecondaryDark}}"
                               HorizontalOptions="Center" />
                    </VerticalStackLayout>
                </Frame>
                <!-- Safety & Security -->
                <Frame BorderColor="{StaticResource Primary}"
                       CornerRadius="{StaticResource CornerRadiusLarge}"
                       Padding="{StaticResource CardPadding}">
                    <VerticalStackLayout Spacing="{StaticResource SpacingSmall}">
                        <Label Text="Security Settings"
                               FontSize="{StaticResource FontSizeSubtitle}"
                               FontAttributes="Bold" />
                        <Grid ColumnDefinitions="*,Auto"
                              RowDefinitions="Auto,Auto,Auto"
                              RowSpacing="{StaticResource SpacingMedium}">
                            <Label Text="Require Confirmation Before Actions"
                                   Grid.Row="0"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch Grid.Row="0"
                                    Grid.Column="1"
                                    IsToggled="True"
                                    OnColor="{StaticResource Primary}" />
                            <Label Text="Limit to Non-Critical Applications"
                                   Grid.Row="1"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch Grid.Row="1"
                                    Grid.Column="1"
                                    IsToggled="True"
                                    OnColor="{StaticResource Primary}" />
                            <Label Text="Restrict To Current User Session"
                                   Grid.Row="2"
                                   Grid.Column="0"
                                   VerticalOptions="Center" />
                            <Switch Grid.Row="2"
                                    Grid.Column="1"
                                    IsToggled="True"
                                    OnColor="{StaticResource Primary}" />
                        </Grid>
                        <Button Text="Reset Permissions"
                                BackgroundColor="Transparent"
                                BorderColor="{StaticResource Error}"
                                BorderWidth="2"
                                TextColor="{StaticResource Error}"
                                Margin="{StaticResource MarginTopMedium}" />
                    </VerticalStackLayout>
                </Frame>
            </VerticalStackLayout>
        </ScrollView>
    </ContentPage.Content>
</ContentPage>